<script>
    // ============ بيانات الموظفين ============
    const employees = [
        {
            id: 1,
            fullName: "توفيق سالم ابتهال",
            jobNumber: "196758925337",
            jobTitle: "رئيس أطباء اختصاص",
            department: "مكتب الوزير / الملاك",
            hireDate: "1991-11-01",
            status: "مستمر بالخدمة",
            gender: "ذكر",
            nationalId: "",
            motherName: "",
            birthDate: "",
            notes: ""
        },
        {
            id: 2,
            fullName: "احمد ابراهيم سلمان",
            jobNumber: "200065880073",
            jobTitle: "تقني أشعة وسونار",
            department: "مكتب الوزير / الملاك",
            hireDate: "2023-11-19",
            status: "مستمر بالخدمة",
            gender: "ذكر",
            nationalId: "",
            motherName: "",
            birthDate: "",
            notes: ""
        },
        {
            id: 3,
            fullName: "سعاد محمد مبارك",
            jobNumber: "113023332",
            jobTitle: "رئيس ممرضين",
            department: "دائرة الموارد البشرية",
            hireDate: "2005-07-31",
            status: "إجازة",
            gender: "أنثى",
            nationalId: "",
            motherName: "",
            birthDate: "",
            notes: ""
        },
        {
            id: 4,
            fullName: "حسن فليح إسماعيل",
            jobNumber: "115714223",
            jobTitle: "طبيب اختصاص أشعة",
            department: "مكتب الوزير / الملاك",
            hireDate: "2010-01-18",
            status: "مستمر بالخدمة",
            gender: "ذكر",
            nationalId: "",
            motherName: "",
            birthDate: "",
            notes: ""
        },
        {
            id: 5,
            fullName: "هند كامل محمد",
            jobNumber: "113056239",
            jobTitle: "رئيس مصوري أشعة",
            department: "مكتب الوزير / الملاك",
            hireDate: "2014-03-20",
            status: "متقاعد",
            gender: "أنثى",
            nationalId: "",
            motherName: "",
            birthDate: "",
            notes: ""
        },
        {
            id: 6,
            fullName: "مها معاذ عباس",
            jobNumber: "153434619",
            jobTitle: "تقنية تمريض",
            department: "دائرة الموارد البشرية",
            hireDate: "2023-09-24",
            status: "متدرب",
            gender: "أنثى",
            nationalId: "",
            motherName: "",
            birthDate: "",
            notes: ""
        }
    ];

    // ============ بيانات الإجازات ============
    const leaves = [
        { id: 1, employeeId: 3, employeeName: "سعاد محمد مبارك", type: "مرضية",   startDate: "2025-01-05", endDate: "2025-01-10", status: "مقبولة", approvedBy: "رئيس قسم التمريض" },
        { id: 2, employeeId: 4, employeeName: "حسن فليح إسماعيل", type: "اعتيادية", startDate: "2025-02-01", endDate: "2025-02-07", status: "مقدمة", approvedBy: "" },
        { id: 3, employeeId: 5, employeeName: "هند كامل محمد",    type: "اعتيادية", startDate: "2024-12-01", endDate: "2024-12-10", status: "منتهية", approvedBy: "مدير المستشفى" },
        { id: 4, employeeId: 6, employeeName: "مها معاذ عباس",    type: "طارئة",    startDate: "2025-03-15", endDate: "2025-03-18", status: "مرفوضة", approvedBy: "رئيس الموارد البشرية" }
    ];

    let currentView = [...employees];
    let currentLeavesView = [...leaves];
    let editingEmployeeId = null;

    // ============ عناصر DOM ============
    const bodyEl = document.body;
    const themeSelect = document.getElementById("themeSelect");

    // موظفون
    const tableBody = document.getElementById("employeesTableBody");
    const totalCountSpan = document.getElementById("totalCount");
    const activeCountSpan = document.getElementById("activeCount");
    const maleCountSpan = document.getElementById("maleCount");
    const femaleCountSpan = document.getElementById("femaleCount");
    const statusStatsSpan = document.getElementById("statusStats");
    const deptStatsSpan = document.getElementById("deptStats");

    const filterForm = document.getElementById("filterForm");
    const filterName = document.getElementById("filterName");
    const filterDept = document.getElementById("filterDept");
    const filterStatus = document.getElementById("filterStatus");
    const btnReset = document.getElementById("btnReset");

    const btnAdd = document.getElementById("btnAdd");
    const btnExport = document.getElementById("btnExport");

    // لوحة التحكم
    const dashTotalEmployees = document.getElementById("dashTotalEmployees");
    const dashActiveEmployees = document.getElementById("dashActiveEmployees");
    const dashMaleEmployees = document.getElementById("dashMaleEmployees");
    const dashFemaleEmployees = document.getElementById("dashFemaleEmployees");
    const dashTotalLeaves = document.getElementById("dashTotalLeaves");
    const dashAcceptedLeaves = document.getElementById("dashAcceptedLeaves");
    const dashPendingLeaves = document.getElementById("dashPendingLeaves");

    // إجازات
    const leavesTableBody = document.getElementById("leavesTableBody");
    const totalLeavesSpan = document.getElementById("totalLeaves");
    const pendingLeavesSpan = document.getElementById("pendingLeaves");
    const acceptedLeavesSpan = document.getElementById("acceptedLeaves");
    const rejectedLeavesSpan = document.getElementById("rejectedLeaves");
    const btnAddLeave = document.getElementById("btnAddLeave");
    const filterLeaveForm = document.getElementById("filterLeaveForm");
    const filterLeaveName = document.getElementById("filterLeaveName");
    const filterLeaveType = document.getElementById("filterLeaveType");
    const filterLeaveStatus = document.getElementById("filterLeaveStatus");
    const btnResetLeaves = document.getElementById("btnResetLeaves");

    // تقارير
    const deptReportBody = document.getElementById("deptReportBody");
    const statusReportBody = document.getElementById("statusReportBody");
    const genderMaleReport = document.getElementById("genderMaleReport");
    const genderFemaleReport = document.getElementById("genderFemaleReport");
    const genderOtherReport = document.getElementById("genderOtherReport");
    const reportTotalEmployees = document.getElementById("reportTotalEmployees");
    const reportActiveEmployees = document.getElementById("reportActiveEmployees");
    const reportTotalLeaves = document.getElementById("reportTotalLeaves");
    const reportAcceptedLeaves = document.getElementById("reportAcceptedLeaves");
    const reportPendingLeaves = document.getElementById("reportPendingLeaves");

    // نموذج الموظف
    const employeeFormSection = document.getElementById("employeeFormSection");
    const employeeFormTitle = document.getElementById("employeeFormTitle");
    const employeeForm = document.getElementById("employeeForm");
    const employeeFormClose = document.getElementById("employeeFormClose");
    const employeeFormCancel = document.getElementById("employeeFormCancel");

    const empFirstNameInput = document.getElementById("empFirstName");
    const empSecondNameInput = document.getElementById("empSecondName");
    const empThirdNameInput = document.getElementById("empThirdName");
    const empFourthNameInput = document.getElementById("empFourthName");
    const empJobTitleInput = document.getElementById("empJobTitle");
    const empStatusInput = document.getElementById("empStatus");
    const empDeptInput = document.getElementById("empDept");
    const empJobNumberInput = document.getElementById("empJobNumber");
    const empNationalIdInput = document.getElementById("empNationalId");
    const empMotherNameInput = document.getElementById("empMotherName");
    const empGenderInput = document.getElementById("empGender");
    const empBirthDateInput = document.getElementById("empBirthDate");
    const empHireDateInput = document.getElementById("empHireDate");
    const empNotesInput = document.getElementById("empNotes");

    // ============ توابع مساعدة ============
    function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        const day = String(d.getDate()).padStart(2, "0");
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function getEmployeeFullName(emp) {
        if (emp.fullName) return emp.fullName;
        const parts = [
            emp.firstName || "",
            emp.secondName || "",
            emp.thirdName || "",
            emp.fourthName || ""
        ].filter(Boolean);
        return parts.join(" ");
    }

    // ============ إحصائيات الموظفين ============
    function calculateEmployeeStats(list) {
        const stats = { total: list.length, active: 0, male: 0, female: 0, other: 0, byStatus: {}, byDept: {} };
        list.forEach(emp => {
            if (emp.status === "مستمر بالخدمة") stats.active++;
            const st = emp.status || "غير محدد";
            const dept = emp.department || "غير محدد";
            stats.byStatus[st] = (stats.byStatus[st] || 0) + 1;
            stats.byDept[dept] = (stats.byDept[dept] || 0) + 1;

            const g = emp.gender || "";
            if (g === "ذكر") stats.male++;
            else if (g === "أنثى") stats.female++;
            else stats.other++;
        });
        return stats;
    }

    function renderEmployeeStats(list) {
        const s = calculateEmployeeStats(list);

        totalCountSpan.textContent = s.total;
        activeCountSpan.textContent = s.active;
        maleCountSpan.textContent = s.male;
        femaleCountSpan.textContent = s.female;

        dashTotalEmployees.textContent = s.total;
        dashActiveEmployees.textContent = s.active;
        dashMaleEmployees.textContent = s.male;
        dashFemaleEmployees.textContent = s.female;

        reportTotalEmployees.textContent = s.total;
        reportActiveEmployees.textContent = s.active;

        statusStatsSpan.textContent = Object.entries(s.byStatus).map(([k, v]) => `${k}: ${v}`).join(" | ");
        deptStatsSpan.textContent = Object.entries(s.byDept).map(([k, v]) => `${k}: ${v}`).join(" | ");

        deptReportBody.innerHTML = "";
        Object.entries(s.byDept).forEach(([dept, count]) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${dept}</td><td>${count}</td>`;
            deptReportBody.appendChild(tr);
        });

        statusReportBody.innerHTML = "";
        Object.entries(s.byStatus).forEach(([st, count]) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${st}</td><td>${count}</td>`;
            statusReportBody.appendChild(tr);
        });

        genderMaleReport.textContent = s.male;
        genderFemaleReport.textContent = s.female;
        genderOtherReport.textContent = s.other;
    }

    // ============ عرض جدول الموظفين ============
    function renderEmployees(list) {
        tableBody.innerHTML = "";
        list.forEach((emp, i) => {
            const tr = document.createElement("tr");
            const fullName = getEmployeeFullName(emp);
            const statusClass =
                emp.status === "مستمر بالخدمة" ? "bg-success" :
                emp.status === "إجازة" ? "bg-warning" :
                emp.status === "متقاعد" ? "bg-secondary" : "bg-info";

            tr.innerHTML = `
              <td>${i + 1}</td>
              <td>${fullName}</td>
              <td>${emp.jobNumber || ""}</td>
              <td>${emp.jobTitle || ""}</td>
              <td>${emp.department || ""}</td>
              <td>${formatDate(emp.hireDate)}</td>
              <td><span class="badge ${statusClass} badge-status">${emp.status || ""}</span></td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewEmployee(${emp.id})">عرض</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="editEmployee(${emp.id})">تعديل</button>
              </td>`;
            tableBody.appendChild(tr);
        });
        renderEmployeeStats(list);
    }

    // ============ الثيم ============
    function applyTheme(themeClass) {
        bodyEl.classList.remove("theme-light", "theme-dark", "theme-ocean", "theme-sepia", "theme-comfort");
        bodyEl.classList.add(themeClass);
        localStorage.setItem("hr_theme", themeClass);
    }

    themeSelect.addEventListener("change", e => applyTheme(e.target.value));
    const savedTheme = localStorage.getItem("hr_theme") || "theme-comfort";
    applyTheme(savedTheme);
    themeSelect.value = savedTheme;

    // ============ فلاتر الموظفين ============
    function applyEmployeeFilters() {
        const nameVal = filterName.value.trim();
        const deptVal = filterDept.value;
        const statusVal = filterStatus.value;

        currentView = employees.filter(emp => {
            const mName = !nameVal || getEmployeeFullName(emp).includes(nameVal);
            const mDept = !deptVal || emp.department === deptVal;
            const mStatus = !statusVal || emp.status === statusVal;
            return mName && mDept && mStatus;
        });

        renderEmployees(currentView);
    }

    filterForm.addEventListener("submit", e => {
        e.preventDefault();
        applyEmployeeFilters();
    });

    btnReset.addEventListener("click", () => {
        filterName.value = "";
        filterDept.value = "";
        filterStatus.value = "";
        currentView = [...employees];
        renderEmployees(currentView);
    });

    // ============ نموذج الموظف (فتح/إغلاق) ============
    function clearEmployeeForm() {
        empFirstNameInput.value = "";
        empSecondNameInput.value = "";
        empThirdNameInput.value = "";
        empFourthNameInput.value = "";
        empJobTitleInput.value = "";
        empStatusInput.value = "مستمر بالخدمة";
        empDeptInput.value = "";
        empJobNumberInput.value = "";
        empNationalIdInput.value = "";
        empMotherNameInput.value = "";
        empGenderInput.value = "";
        empBirthDateInput.value = "";
        empHireDateInput.value = "";
        empNotesInput.value = "";
    }

    function fillEmployeeForm(emp) {
        const parts = (getEmployeeFullName(emp) || "").split(/\s+/);
        empFirstNameInput.value = emp.firstName || parts[0] || "";
        empSecondNameInput.value = emp.secondName || parts[1] || "";
        empThirdNameInput.value = emp.thirdName || parts[2] || "";
        empFourthNameInput.value = emp.fourthName || parts[3] || "";

        empJobTitleInput.value = emp.jobTitle || "";
        empStatusInput.value = emp.status || "مستمر بالخدمة";
        empDeptInput.value = emp.department || "";
        empJobNumberInput.value = emp.jobNumber || "";
        empNationalIdInput.value = emp.nationalId || "";
        empMotherNameInput.value = emp.motherName || "";
        empGenderInput.value = emp.gender || "";
        empBirthDateInput.value = emp.birthDate || "";
        empHireDateInput.value = emp.hireDate || "";
        empNotesInput.value = emp.notes || "";
    }

    function openEmployeeForm(mode, emp) {
        if (mode === "add") {
            editingEmployeeId = null;
            employeeFormTitle.textContent = "إضافة موظف جديد";
            clearEmployeeForm();
        } else if (mode === "edit" && emp) {
            editingEmployeeId = emp.id;
            employeeFormTitle.textContent = "تعديل بيانات الموظف";
            fillEmployeeForm(emp);
        }
        employeeFormSection.classList.remove("d-none");
        employeeFormSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function closeEmployeeForm() {
        employeeFormSection.classList.add("d-none");
    }

    employeeFormClose.addEventListener("click", closeEmployeeForm);
    employeeFormCancel.addEventListener("click", closeEmployeeForm);

    // زر إضافة موظف => فتح النموذج
    btnAdd.addEventListener("click", () => openEmployeeForm("add", null));

    // حفظ بيانات النموذج
    employeeForm.addEventListener("submit", e => {
        e.preventDefault();

        const firstName = empFirstNameInput.value.trim();
        const secondName = empSecondNameInput.value.trim();
        const thirdName = empThirdNameInput.value.trim();
        const fourthName = empFourthNameInput.value.trim();
        const jobTitle = empJobTitleInput.value.trim();
        const status = empStatusInput.value;
        const dept = empDeptInput.value.trim();
        const jobNumber = empJobNumberInput.value.trim();

        if (!firstName || !jobTitle || !dept || !jobNumber) {
            alert("الرجاء تعبئة الحقول الأساسية (الاسم الأول، العنوان الوظيفي، الدائرة، الرقم الوظيفي).");
            return;
        }

        const fullName = [firstName, secondName, thirdName, fourthName].filter(Boolean).join(" ");

        const commonData = {
            fullName,
            firstName,
            secondName,
            thirdName,
            fourthName,
            jobTitle,
            status,
            department: dept,
            jobNumber,
            nationalId: empNationalIdInput.value.trim(),
            motherName: empMotherNameInput.value.trim(),
            gender: empGenderInput.value,
            birthDate: empBirthDateInput.value,
            hireDate: empHireDateInput.value,
            notes: empNotesInput.value.trim()
        };

        if (editingEmployeeId === null) {
            const newId = employees.length ? Math.max(...employees.map(e => e.id)) + 1 : 1;
            const newEmp = { id: newId, ...commonData };
            employees.push(newEmp);
            alert("تمت إضافة الموظف بنجاح.");
        } else {
            const emp = employees.find(e => e.id === editingEmployeeId);
            if (!emp) {
                alert("لم يتم العثور على الموظف.");
                return;
            }
            Object.assign(emp, commonData);
            alert("تم تحديث بيانات الموظف.");
        }

        currentView = [...employees];
        renderEmployees(currentView);
        closeEmployeeForm();
    });

    // ============ تصدير الموظفين ============
    btnExport.addEventListener("click", () => {
        const list = currentView;
        if (!list.length) {
            alert("لا توجد بيانات لتصديرها.");
            return;
        }

        // العناوين حسب الجدول الذي أرسلته
        const header = [
            "الأسم الاول",
            "الأسم الثاني",
            "الأسم الثالث",
            "الأسم الرابع",
            "العنوان الوظيفي",
            "الحالة الوظيفية",
            "الملاحظات",
            "أسم الدائرة / مبنى الوزارة",
            "الرقم الوظيفي",
            "الرقم الوطني",
            "أسم الأم الثلاثي",
            "الجنس",
            "تاريخ التولد",
            "تاريخ التعيين"
        ];

        const rows = list.map(emp => {
            const parts = (getEmployeeFullName(emp) || "").split(/\s+/);
            const firstName = emp.firstName || parts[0] || "";
            const secondName = emp.secondName || parts[1] || "";
            const thirdName = emp.thirdName || parts[2] || "";
            const fourthName = emp.fourthName || parts[3] || "";
            return [
                firstName,
                secondName,
                thirdName,
                fourthName,
                emp.jobTitle || "",
                emp.status || "",
                emp.notes || "",
                emp.department || "",
                emp.jobNumber || "",
                emp.nationalId || "",
                emp.motherName || "",
                emp.gender || "",
                emp.birthDate || "",
                emp.hireDate || ""
            ];
        });

        const csv = [header, ...rows]
            .map(row => row.map(f => `"${String(f).replace(/"/g, '""')}"`).join(","))
            .join("\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "employees.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // ============ عرض / تعديل موظف (باستخدام النموذج) ============
    window.viewEmployee = id => {
        const emp = employees.find(e => e.id === id);
        if (!emp) {
            alert("لم يتم العثور على الموظف.");
            return;
        }
        const info =
            "معلومات الموظف:\n\n" +
            `الاسم الكامل: ${getEmployeeFullName(emp)}\n` +
            `الرقم الوظيفي: ${emp.jobNumber || ""}\n` +
            `الرقم الوطني: ${emp.nationalId || ""}\n` +
            `العنوان الوظيفي: ${emp.jobTitle || ""}\n` +
            `الدائرة: ${emp.department || ""}\n` +
            `الحالة الوظيفية: ${emp.status || ""}\n` +
            `الجنس: ${emp.gender || "غير محدد"}\n` +
            `أسم الأم الثلاثي: ${emp.motherName || ""}\n` +
            `تاريخ التولد: ${emp.birthDate || ""}\n` +
            `تاريخ التعيين: ${emp.hireDate || ""}\n` +
            `الملاحظات: ${emp.notes || ""}`;
        alert(info);
    };

    window.editEmployee = id => {
        const emp = employees.find(e => e.id === id);
        if (!emp) {
            alert("لم يتم العثور على الموظف.");
            return;
        }
        openEmployeeForm("edit", emp);
    };

    // ============ إجازات ============
    function calculateLeaveStats(list) {
        const s = { total: list.length, pending: 0, accepted: 0, rejected: 0 };
        list.forEach(l => {
            if (l.status === "مقدمة") s.pending++;
            else if (l.status === "مقبولة") s.accepted++;
            else if (l.status === "مرفوضة") s.rejected++;
        });
        return s;
    }

    function renderLeaveStats(list) {
        const s = calculateLeaveStats(list);

        totalLeavesSpan.textContent = s.total;
        pendingLeavesSpan.textContent = s.pending;
        acceptedLeavesSpan.textContent = s.accepted;
        rejectedLeavesSpan.textContent = s.rejected;

        dashTotalLeaves.textContent = s.total;
        dashAcceptedLeaves.textContent = s.accepted;
        dashPendingLeaves.textContent = s.pending;

        reportTotalLeaves.textContent = s.total;
        reportAcceptedLeaves.textContent = s.accepted;
        reportPendingLeaves.textContent = s.pending;
    }

    function renderLeaves(list) {
        leavesTableBody.innerHTML = "";
        list.forEach((lv, i) => {
            const statusClass =
                lv.status === "مقبولة" ? "bg-success" :
                lv.status === "مقدمة" ? "bg-warning" :
                lv.status === "مرفوضة" ? "bg-danger" : "bg-secondary";

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${i + 1}</td>
              <td>${lv.employeeName}</td>
              <td>${lv.type}</td>
              <td>${formatDate(lv.startDate)}</td>
              <td>${formatDate(lv.endDate)}</td>
              <td><span class="badge ${statusClass} badge-status">${lv.status}</span></td>
              <td>${lv.approvedBy || "-"}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewLeave(${lv.id})">عرض</button>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="editLeaveStatus(${lv.id})">تحديث الحالة</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteLeave(${lv.id})">حذف</button>
              </td>`;
            leavesTableBody.appendChild(tr);
        });

        renderLeaveStats(list);
    }

    filterLeaveForm.addEventListener("submit", e => {
        e.preventDefault();
        const nameVal = filterLeaveName.value.trim();
        const typeVal = filterLeaveType.value;
        const statusVal = filterLeaveStatus.value;

        currentLeavesView = leaves.filter(lv => {
            const mName = !nameVal || lv.employeeName.includes(nameVal);
            const mType = !typeVal || lv.type === typeVal;
            const mStatus = !statusVal || lv.status === statusVal;
            return mName && mType && mStatus;
        });
        renderLeaves(currentLeavesView);
    });

    btnResetLeaves.addEventListener("click", () => {
        filterLeaveName.value = "";
        filterLeaveType.value = "";
        filterLeaveStatus.value = "";
        currentLeavesView = [...leaves];
        renderLeaves(currentLeavesView);
    });

    btnAddLeave.addEventListener("click", () => {
        const employeeName = prompt("أدخل اسم الموظف:"); if (!employeeName) return;
        const type = prompt("نوع الإجازة:", "اعتيادية");
        const startDate = prompt("تاريخ البدء (YYYY-MM-DD):", "2025-01-01");
        const endDate = prompt("تاريخ النهاية (YYYY-MM-DD):", "2025-01-07");
        const status = prompt("حالة الطلب:", "مقدمة");
        const approvedBy = prompt("اسم المعتمد:", "");
        const newId = leaves.length ? Math.max(...leaves.map(l => l.id)) + 1 : 1;
        leaves.push({
            id: newId,
            employeeId: null,
            employeeName,
            type: type || "اعتيادية",
            startDate: startDate || "",
            endDate: endDate || "",
            status: status || "مقدمة",
            approvedBy: approvedBy || ""
        });
        currentLeavesView = [...leaves];
        renderLeaves(currentLeavesView);
        alert("تمت إضافة طلب الإجازة.");
    });

    window.viewLeave = id => {
        const lv = leaves.find(l => l.id === id);
        if (!lv) { alert("لم يتم العثور على الإجازة."); return; }
        alert(
            "معلومات الإجازة:\n\n" +
            `الموظف: ${lv.employeeName}\n` +
            `نوع الإجازة: ${lv.type}\n` +
            `من: ${formatDate(lv.startDate)}\n` +
            `إلى: ${formatDate(lv.endDate)}\n` +
            `الحالة: ${lv.status}\n` +
            `المعتمد: ${lv.approvedBy || "-"}` );
    };

    window.editLeaveStatus = id => {
        const lv = leaves.find(l => l.id === id);
        if (!lv) { alert("لم يتم العثور على الإجازة."); return; }
        const status = prompt("تحديث حالة الإجازة:", lv.status); if (!status) return;
        const approvedBy = prompt("اسم المعتمد:", lv.approvedBy || "");
        lv.status = status;
        lv.approvedBy = approvedBy || lv.approvedBy;
        renderLeaves(currentLeavesView);
        alert("تم تحديث حالة الإجازة.");
    };

    window.deleteLeave = id => {
        if (!confirm("هل أنت متأكد من حذف هذه الإجازة؟")) return;
        const idx = leaves.findIndex(l => l.id === id);
        if (idx === -1) { alert("لم يتم العثور على الإجازة."); return; }
        leaves.splice(idx, 1);
        currentLeavesView = [...leaves];
        renderLeaves(currentLeavesView);
        alert("تم حذف الإجازة.");
    };

    // ============ التنقل بين لوحة التحكم / الموظفين / الإجازات / التقارير ============
    const navLinks = document.querySelectorAll(".sidebar .nav-link");

    function showSection(sectionId) {
        const ids = ["dashboard", "employees", "leaves", "reports"];
        ids.forEach(id => {
            const sec = document.getElementById(id);
            if (!sec) return;
            if (id === sectionId) sec.classList.remove("d-none");
            else sec.classList.add("d-none");
        });

        navLinks.forEach(link => {
            const href = link.getAttribute("href") || "";
            if (!href.startsWith("#")) return;
            const targetId = href.substring(1);
            link.classList.toggle("active", targetId === sectionId);
        });

        window.scrollTo({ top: 0, behavior: "auto" });
    }

    navLinks.forEach(link => {
        const href = link.getAttribute("href") || "";
        if (!href.startsWith("#")) return;
        const targetId = href.substring(1);
        if (["dashboard", "employees", "leaves", "reports"].includes(targetId)) {
            link.addEventListener("click", e => {
                e.preventDefault();
                showSection(targetId);
            });
        }
    });

    const logoutLink = Array.from(navLinks).find(l => (l.textContent || "").trim() === "تسجيل الخروج");
    if (logoutLink) {
        logoutLink.addEventListener("click", e => {
            e.preventDefault();
            alert("تم تسجيل الخروج (تجريبيًا، يمكن ربطه لاحقًا بصفحة دخول).");
        });
    }

    // ============ أول تحميل ============
    currentView = [...employees];
    currentLeavesView = [...leaves];
    renderEmployees(currentView);
    renderLeaves(currentLeavesView);
    showSection("dashboard");
</script>
