<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام إدارة الموظفين - ابن سينا التعليمي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS RTL -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">

  <style>
    :root{
      --bg-color:#f5f6fa;
      --bg-soft:#ffffff;
      --text-color:#1f2933;
      --muted-text:#6b7280;
      --accent:#0d6efd;
      --accent-soft:rgba(13,110,253,.08);
      --border-color:#e5e7eb;
      --sidebar-bg:#0d6efd;
      --sidebar-text:#ffffff;
      --shadow-soft:0 12px 30px rgba(15,23,42,.08);
      --table-header-bg:#e9ecef;

      /* تحكم بالحجم (افتراضي) */
      --font-scale: 1;
    }
    .theme-light{
      --bg-color:#f5f6fa;
      --bg-soft:#ffffff;
      --text-color:#111827;
      --muted-text:#6b7280;
      --accent:#0d6efd;
      --accent-soft:rgba(13,110,253,.08);
      --border-color:#e5e7eb;
      --sidebar-bg:#0d6efd;
      --sidebar-text:#ffffff;
      --table-header-bg:#eef2ff;
    }
    .theme-dark{
      --bg-color:#030712;
      --bg-soft:#020617;
      --text-color:#e5e7eb;
      --muted-text:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.1);
      --border-color:#1f2937;
      --sidebar-bg:#020617;
      --sidebar-text:#e5e7eb;
      --table-header-bg:#111827;
    }
    .theme-ocean{
      --bg-color:#0f172a;
      --bg-soft:#0b1220;
      --text-color:#e5e7eb;
      --muted-text:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:rgba(38,198,249,.14);
      --border-color:#1e293b;
      --sidebar-bg:#020617;
      --sidebar-text:#e5e7eb;
      --table-header-bg:#0b1120;
    }
    .theme-sepia{
      --bg-color:#f4eee2;
      --bg-soft:#fdf7ec;
      --text-color:#3b2f2f;
      --muted-text:#7c6a5f;
      --accent:#c47f3a;
      --accent-soft:rgba(196,127,58,.1);
      --border-color:#e0d0b8;
      --sidebar-bg:#c47f3a;
      --sidebar-text:#fff7ec;
      --table-header-bg:#f3e3cf;
    }
    .theme-comfort{
      --bg-color:#edf2f7;
      --bg-soft:#ffffff;
      --text-color:#1a202c;
      --muted-text:#718096;
      --accent:#4299e1;
      --accent-soft:rgba(66,153,225,.12);
      --border-color:#e2e8f0;
      --sidebar-bg:#2d3748;
      --sidebar-text:#e2e8f0;
      --table-header-bg:#e2e8f0;
    }

    .theme-hospital-blue{
      --bg-color:#e9f4ff;
      --bg-soft:#ffffff;
      --text-color:#102a43;
      --muted-text:#627d98;
      --accent:#0ea5e9;
      --accent-soft:rgba(14,165,233,.14);
      --border-color:#cbd2e1;
      --sidebar-bg:#0f172a;
      --sidebar-text:#e5e7eb;
      --table-header-bg:#dbeafe;
    }
    .theme-hospital-soft{
      --bg-color:#f6fbff;
      --bg-soft:#ffffff;
      --text-color:#1f2933;
      --muted-text:#6b7280;
      --accent:#10b981;
      --accent-soft:rgba(16,185,129,.12);
      --border-color:#d1e3f0;
      --sidebar-bg:#0284c7;
      --sidebar-text:#f9fafb;
      --table-header-bg:#e0f2fe;
    }
    .theme-hospital-dark{
      --bg-color:#020617;
      --bg-soft:#020617;
      --text-color:#e5e7eb;
      --muted-text:#9ca3af;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.18);
      --border-color:#1f2937;
      --sidebar-bg:#020617;
      --sidebar-text:#e5e7eb;
      --table-header-bg:#020617;
    }

    /* تطبيق مقياس الخط على الصفحة */
    html{
      font-size: calc(16px * var(--font-scale));
    }

    body{
      background-color:var(--bg-color);
      color:var(--text-color);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      line-height:1.6;
    }

    /* تحسين عام للمسافات */
    .container-fluid{ padding:0; }
    main{ background-color:var(--bg-color); min-height:100vh; }
    section{ margin-bottom:1.25rem; }
    .page-title{ font-weight:800; letter-spacing:.2px; }
    .text-muted{ color:var(--muted-text) !important; }

    /* بطاقات */
    .card{
      border:1px solid var(--border-color);
      background-color:var(--bg-soft);
      box-shadow:var(--shadow-soft);
      border-radius:1rem;
    }
    .card-body{ padding:1.25rem; }

    /* أزرار */
    .btn-primary,.btn-outline-primary:hover{
      background-color:var(--accent);
      border-color:var(--accent);
    }
    .btn-outline-primary{ color:var(--accent); border-color:var(--accent); }
    .btn{ border-radius:.75rem; }
    .btn-sm{ padding:.45rem .75rem; }

    /* الشريط الجانبي */
    .sidebar{
      min-height:100vh;
      background:var(--sidebar-bg);
      color:var(--sidebar-text);
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
    }
    .sidebar a{
      color:var(--sidebar-text);
      text-decoration:none;
      border-radius:.75rem;
      padding:.6rem .9rem;
      display:block;
    }
    .sidebar a:hover{ background-color:rgba(255,255,255,.08); }
    .sidebar a.active{ background:rgba(255,255,255,.16); }
    .sidebar-header-brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }
    .sidebar-title{
      display:flex;
      flex-direction:column;
      gap:.15rem;
    }
    .sidebar-title h5{ margin:0; font-weight:800; }
    .sidebar-title small{ opacity:.85; }

    /* تمت إزالة اللوگو والبانر */
    .sidebar-logo-box img,
    .app-header-banner{ display:none !important; }

    /* شريط أعلى المحتوى */
    .topbar{
      background:var(--bg-soft);
      border:1px solid var(--border-color);
      box-shadow:var(--shadow-soft);
      border-radius:1rem;
      padding:1rem 1.25rem;
      margin-bottom:1rem;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }
    .theme-selector{ min-width:220px; }

    /* شرائح الإحصائيات */
    .filter-chip{
      background-color:var(--accent-soft);
      border:1px solid rgba(0,0,0,.03);
      border-radius:999px;
      padding:.35rem .85rem;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      white-space:nowrap;
    }

    /* فورم الفلاتر */
    #filterForm .form-label{ font-weight:700; font-size:.9rem; margin-bottom:.35rem; }
    .form-control,.form-select{
      border-radius:.75rem;
      border-color:var(--border-color);
      padding:.55rem .75rem;
    }

    /* الجدول */
    .employee-table-wrapper{
      height:calc(100vh - 345px);
      min-height:360px;
      overflow:auto;
      border-radius:.9rem;
      border:1px solid var(--border-color);
      background:var(--bg-soft);
    }
    .employee-table{
      min-width:1350px;
      border-collapse:separate;
      border-spacing:0;
      font-size:.86rem;
    }
    .employee-table thead th{
      position:sticky;
      top:0;
      z-index:2;
      background-color:var(--table-header-bg);
      border-bottom:1px solid var(--border-color);
      box-shadow:0 2px 4px rgba(15,23,42,.06);
      text-align:center;
      white-space:nowrap;
      user-select:none;
      padding:.7rem .6rem;
    }
    .employee-table thead th.sortable{ cursor:pointer; }
    .employee-table thead th.sortable::after{
      content:"⇅";
      font-size:.75rem;
      margin-right:.35rem;
      opacity:.35;
    }
    .employee-table thead th.sort-asc::after{ content:"▲"; opacity:.8; }
    .employee-table thead th.sort-desc::after{ content:"▼"; opacity:.8; }
    .employee-table tbody td{
      vertical-align:middle;
      white-space:nowrap;
      padding:.55rem .55rem;
    }
    .employee-table tbody tr:nth-child(even){ background-color:rgba(148,163,184,.06); }
    .employee-table tbody tr:hover{ background-color:rgba(59,130,246,.10); }

    .badge-status{
      font-size:.72rem;
      padding:.3rem .55rem;
      border-radius:999px;
    }

    /* طبقة نموذج الموظف */
    .employee-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:1.5rem 1rem;
      z-index:1050;
    }
    .employee-overlay .card{
      width:100%;
      max-width:1200px;
      max-height:calc(100vh - 3rem);
      overflow:auto;
    }

    /* ===== Dropdown التحكم بحجم الخط (أسفل يمين) ===== */
    .font-size-widget{
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 2000;
      background: var(--bg-soft);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-soft);
      border-radius: 999px;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .font-size-widget .label{
      font-size: .72rem;
      color: var(--muted-text);
      white-space: nowrap;
      padding: 0 2px;
    }
    .font-size-widget .form-select{
      width: 108px;
      font-size: .75rem;
      border-radius: 999px;
      padding: .18rem 1.5rem .18rem .55rem;
      border-color: var(--border-color);
      line-height: 1.2;
    }
    @media (max-width: 576px){
      .font-size-widget{
        right: 8px;
        bottom: 8px;
        padding: 4px 6px;
        gap: 6px;
      }
      .font-size-widget .form-select{
        width: 100px;
        font-size: .72rem;
      }
    }

    /* تحسين استجابة الموبايل */
    @media (max-width: 992px){
      .sidebar{
        position:relative;
        height:auto;
        min-height:auto;
      }
      main{ padding:1rem !important; }
      .employee-table-wrapper{ height:auto; min-height:320px; }
      .theme-selector{ width:100%; min-width:auto; }
    }
  </style>
</head>

<body class="theme-hospital-soft">
<div class="container-fluid">
  <div class="row g-0">

    <!-- الشريط الجانبي -->
    <nav class="col-lg-2 col-md-3 sidebar p-3">
      <div class="sidebar-header-brand mb-3">
        <div class="sidebar-title">
          <h5>نظام الموظفين</h5>
          <small class="text-white-50">إدارة الموارد البشرية</small>
        </div>
        <span class="badge bg-light text-dark">HR</span>
      </div>

      <ul class="nav flex-column gap-1">
        <li class="nav-item"><a class="nav-link" href="#dashboard">لوحة التحكم</a></li>
        <li class="nav-item"><a class="nav-link active" href="#employees">الموظفون</a></li>
        <li class="nav-item"><a class="nav-link" href="#reports">التقارير</a></li>
        <li class="nav-item mt-4"><a class="nav-link" href="#logout">تسجيل الخروج</a></li>
      </ul>
    </nav>

    <!-- المحتوى -->
    <main class="col-lg-10 col-md-9 ms-auto p-4">

      <!-- Topbar -->
      <div class="topbar">
        <div>
          <h2 class="page-title mb-1">نظام إدارة موظفي ابن سينا التعليمي</h2>
          <p class="text-muted mb-0">لوحة تحكم، موظفون، وتقارير في منصة واحدة.</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="text-muted small">ثيم الواجهة:</span>
          <select id="themeSelect" class="form-select form-select-sm theme-selector">
            <option value="theme-hospital-soft">واجهة ناعمة (افتراضي)</option>
            <option value="theme-hospital-blue">واجهة زرقاء</option>
            <option value="theme-hospital-dark">واجهة داكنة</option>
            <option value="theme-comfort">مريح</option>
            <option value="theme-light">فاتح</option>
            <option value="theme-dark">داكن</option>
            <option value="theme-ocean">أوشن</option>
            <option value="theme-sepia">سيبيا</option>
          </select>
        </div>
      </div>

      <!-- لوحة التحكم -->
      <section id="dashboard">
        <h4 class="section-title">لوحة التحكم</h4>
        <p class="text-muted">نظرة سريعة على أعداد الموظفين.</p>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <div class="card p-3">
              <p class="text-muted mb-1">إجمالي الموظفين</p>
              <h3 id="dashTotalEmployees" class="mb-0">0</h3>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <p class="text-muted mb-1">مستمرون بالخدمة</p>
              <h3 id="dashActiveEmployees" class="mb-0">0</h3>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <p class="text-muted mb-1">الذكور</p>
              <h3 id="dashMaleEmployees" class="mb-0">0</h3>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <p class="text-muted mb-1">الإناث</p>
              <h3 id="dashFemaleEmployees" class="mb-0">0</h3>
            </div>
          </div>
        </div>
      </section>

      <!-- الموظفون -->
      <section id="employees">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <div>
            <h4 class="section-title mb-1">قائمة الموظفين</h4>
            <p class="text-muted mb-0">إدارة بيانات جميع الموظفين.</p>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button id="btnImportExcel" class="btn btn-outline-secondary btn-sm">استيراد من Excel</button>
            <input type="file" id="importExcelFile" accept=".csv,.xlsx" class="d-none">

            <button id="btnExportExcel" class="btn btn-outline-primary btn-sm">تصدير إلى Excel</button>

            <button id="btnImportJson" class="btn btn-outline-secondary btn-sm">استيراد JSON</button>
            <input type="file" id="importJsonFile" accept=".json" class="d-none">

            <button id="btnExportJson" class="btn btn-outline-primary btn-sm">تصدير JSON</button>

            <button id="btnSave" class="btn btn-success btn-sm">حفظ البيانات</button>
            <button id="btnAdd" class="btn btn-primary btn-sm">+ إضافة موظف جديد</button>
          </div>
        </div>

        <div class="d-flex justify-content-start align-items-center mb-3 flex-wrap gap-2">
          <span class="filter-chip">المجموع: <span id="totalCount">0</span> موظف</span>
          <span class="filter-chip">مستمر بالخدمة: <span id="activeCount">0</span></span>
          <span class="filter-chip">الذكور: <span id="maleCount">0</span></span>
          <span class="filter-chip">الإناث: <span id="femaleCount">0</span></span>
        </div>

        <div class="mb-3 d-none">
          <small class="text-muted d-block">حالات الخدمة: <span id="statusStats">لا توجد بيانات بعد</span></small>
          <small class="text-muted d-block">توزيع حسب الدائرة: <span id="deptStats">لا توجد بيانات بعد</span></small>
        </div>

        <div class="card">
          <div class="card-body">
            <form id="filterForm" class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label">الاسم</label>
                <input type="text" id="filterName" class="form-control" placeholder="بحث بالاسم">
              </div>
              <div class="col-md-3">
                <label class="form-label">الدائرة</label>
                <select id="filterDept" class="form-select">
                  <option value="">الكل</option>
                  <option value="مكتب الوزير / الملاك">مكتب الوزير / الملاك</option>
                  <option value="دائرة الموارد البشرية">دائرة الموارد البشرية</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">الحالة الوظيفية</label>
                <select id="filterStatus" class="form-select">
                  <option value="">الكل</option>
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-secondary w-100">بحث</button>
                <button type="button" id="btnReset" class="btn btn-outline-secondary">مسح</button>
              </div>
            </form>

            <div class="employee-table-wrapper">
              <table class="employee-table table table-sm table-hover align-middle mb-0">
                <thead>
                <tr id="employeesHeaderRow"></tr>
                </thead>
                <tbody id="employeesTableBody"></tbody>
              </table>
            </div>

          </div>
        </div>
      </section>

      <!-- طبقة نموذج إضافة/تعديل موظف -->
      <div id="employeeFormSection" class="employee-overlay d-none">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 id="employeeFormTitle" class="mb-0">إضافة موظف جديد</h5>
              <button type="button" id="employeeFormClose" class="btn btn-sm btn-outline-secondary">إغلاق النموذج</button>
            </div>

            <form id="employeeForm" class="row g-3">
              <div class="col-md-3">
                <label class="form-label">الأسم الاول</label>
                <input type="text" id="empFirstName" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">الأسم الثاني</label>
                <input type="text" id="empSecondName" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">الأسم الثالث</label>
                <input type="text" id="empThirdName" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">الأسم الرابع</label>
                <input type="text" id="empFourthName" class="form-control">
              </div>

              <div class="col-md-3">
                <label class="form-label">اخر ترفيع</label>
                <input type="date" id="empLastPromotion" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">اخر علاوة سنوية</label>
                <input type="date" id="empLastAnnualBonus" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">العنوان الوظيفي</label>
                <input type="text" id="empJobTitle" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">الحالة الوظيفية</label>
                <select id="empStatus" class="form-select" required></select>
              </div>

              <div class="col-md-4">
                <label class="form-label">أسم الدائرة / مبنى الوزارة</label>
                <input type="text" id="empDept" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">الرقم الوظيفي</label>
                <input type="text" id="empJobNumber" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">الرقم الوطني</label>
                <input type="text" id="empNationalId" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">أسم الأم الثلاثي</label>
                <input type="text" id="empMotherName" class="form-control">
              </div>

              <div class="col-md-3">
                <label class="form-label">الجنس</label>
                <select id="empGender" class="form-select">
                  <option value="">غير محدد</option>
                  <option value="ذكر">ذكر</option>
                  <option value="أنثى">أنثى</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">تاريخ التولد</label>
                <input type="date" id="empBirthDate" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاريخ التعيين</label>
                <input type="date" id="empHireDate" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">الملاحظات</label>
                <input type="text" id="empNotes" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">ملف الموظف (صورة / PDF / ملف آخر)</label>
                <input type="file" id="empFile" class="form-control"
                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar,.eml">
                <div id="empFileInfo" class="form-text mt-1"></div>
              </div>

              <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                <button type="button" id="employeeFormCancel" class="btn btn-outline-secondary">إلغاء</button>
                <button type="submit" class="btn btn-primary">حفظ البيانات</button>
              </div>
            </form>

          </div>
        </div>
      </div>

      <!-- التقارير -->
      <section id="reports">
        <h4 class="section-title">التقارير والإحصائيات</h4>
        <p class="text-muted">توزيع الموظفين حسب الدائرة والحالة والجنس، مع ملخص عام.</p>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="mb-3">توزيع الموظفين حسب الدائرة</h6>
              <table class="table table-sm mb-0">
                <thead>
                <tr>
                  <th>الدائرة</th>
                  <th>عدد الموظفين</th>
                </tr>
                </thead>
                <tbody id="deptReportBody"></tbody>
              </table>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="mb-3">توزيع الموظفين حسب الحالة الوظيفية</h6>
              <table class="table table-sm mb-0">
                <thead>
                <tr>
                  <th>الحالة الوظيفية</th>
                  <th>العدد</th>
                </tr>
                </thead>
                <tbody id="statusReportBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="mb-3">توزيع الموظفين حسب الجنس</h6>
              <table class="table table-sm mb-0">
                <thead>
                <tr>
                  <th>الجنس</th>
                  <th>العدد</th>
                </tr>
                </thead>
                <tbody>
                <tr><td>ذكر</td><td id="genderMaleReport">0</td></tr>
                <tr><td>أنثى</td><td id="genderFemaleReport">0</td></tr>
                <tr><td>غير محدد</td><td id="genderOtherReport">0</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="mb-3">ملخص سريع</h6>
              <ul class="mb-0 small">
                <li>إجمالي الموظفين: <span id="reportTotalEmployees">0</span></li>
                <li>الموظفون على رأس الخدمة: <span id="reportActiveEmployees">0</span></li>
              </ul>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Dropdown التحكم بحجم الخط (أسفل يمين) -->
<div class="font-size-widget" dir="rtl" aria-label="حجم الخط">
  <span class="label">الخط</span>
  <select id="fontSizeSelect" class="form-select form-select-sm" title="حجم الخط">
    <option value="0.60">XXS</option>
    <option value="0.65">XS</option>
    <option value="0.70">S-</option>
    <option value="0.75">S</option>
    <option value="0.80">S+</option>
    <option value="0.85">M-</option>
    <option value="0.90">M</option>
    <option value="1.00" selected>افتراضي</option>
    <option value="1.08">L</option>
    <option value="1.15">XL</option>
    <option value="1.25">XXL</option>
  </select>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  const STORAGE_KEYS = {
    employees: "hr_employees_v1",
    section: "hr_current_section_v1"
  };

  // بيانات أولية
  const employees = [
    {
      id: 1,
      fullName: "توفيق سالم ابتهال",
      jobNumber: "196758925337",
      jobTitle: "رئيس أطباء اختصاص",
      department: "مكتب الوزير / الملاك",
      hireDate: "1991-11-01",
      status: "مستمر بالخدمة",
      gender: "ذكر",
      nationalId: "",
      motherName: "",
      birthDate: "1967-10-05",
      lastPromotion: "",
      lastAnnualBonus: "",
      notes: "",
      extra: {},
      fileName: null,
      fileType: null,
      fileData: null
    },
    {
      id: 2,
      fullName: "احمد ابراهيم سلمان",
      jobNumber: "200065880073",
      jobTitle: "تقني أشعة وسونار",
      department: "مكتب الوزير / الملاك",
      hireDate: "2023-11-19",
      status: "مستمر بالخدمة",
      gender: "ذكر",
      nationalId: "",
      motherName: "",
      birthDate: "2000-02-15",
      lastPromotion: "",
      lastAnnualBonus: "",
      notes: "",
      extra: {},
      fileName: null,
      fileType: null,
      fileData: null
    },
    {
      id: 3,
      fullName: "سعاد محمد مبارك",
      jobNumber: "113023332",
      jobTitle: "رئيس ممرضين",
      department: "دائرة الموارد البشرية",
      hireDate: "2005-07-31",
      status: "إجازة",
      gender: "أنثى",
      nationalId: "",
      motherName: "",
      birthDate: "1968-09-05",
      lastPromotion: "",
      lastAnnualBonus: "",
      notes: "",
      extra: {},
      fileName: null,
      fileType: null,
      fileData: null
    },
    {
      id: 4,
      fullName: "حسن فليح إسماعيل",
      jobNumber: "115714223",
      jobTitle: "طبيب اختصاص أشعة",
      department: "مكتب الوزير / الملاك",
      hireDate: "2010-01-18",
      status: "مستمر بالخدمة",
      gender: "ذكر",
      nationalId: "",
      motherName: "",
      birthDate: "1998-08-22",
      lastPromotion: "",
      lastAnnualBonus: "",
      notes: "",
      extra: {},
      fileName: null,
      fileType: null,
      fileData: null
    }
  ];

  function saveDataToStorage() {
    try { localStorage.setItem(STORAGE_KEYS.employees, JSON.stringify(employees)); }
    catch (e) { console.error("localStorage error:", e); }
  }

  function loadDataFromStorage() {
    try {
      const empStr = localStorage.getItem(STORAGE_KEYS.employees);
      if (empStr) {
        const arr = JSON.parse(empStr);
        if (Array.isArray(arr)) {
          employees.length = 0;
          arr.forEach(e => employees.push(e));
        }
      }
    } catch (e) { console.error("load storage error", e); }
  }

  loadDataFromStorage();

  let currentView = [...employees];
  let editingEmployeeId = null;
  let currentSort = { key: null, dir: "asc" };

  const baseColumns = [
    { key: "index",      label: "#",                          sortable: true },
    { key: "firstName",  label: "الأسم الاول",                sortable: true },
    { key: "secondName", label: "الأسم الثاني",               sortable: true },
    { key: "thirdName",  label: "الأسم الثالث",               sortable: true },
    { key: "fourthName", label: "الأسم الرابع",               sortable: true },
    { key: "lastPromotion", label: "اخر ترفيع",               sortable: true },
    { key: "lastAnnualBonus", label: "اخر علاوة سنوية",       sortable: true },
    { key: "jobTitle",   label: "العنوان الوظيفي",            sortable: true },
    { key: "status",     label: "الحالة الوظيفية",            sortable: true },
    { key: "notes",      label: "الملاحظات",                  sortable: true },
    { key: "department", label: "أسم الدائرة / مبنى الوزارة", sortable: true },
    { key: "jobNumber",  label: "الرقم الوظيفي",              sortable: true },
    { key: "nationalId", label: "الرقم الوطني",               sortable: true },
    { key: "motherName", label: "أسم الأم الثلاثي",           sortable: true },
    { key: "gender",     label: "الجنس",                      sortable: true },
    { key: "birthDate",  label: "تاريخ التولد",               sortable: true },
    { key: "hireDate",   label: "تاريخ التعيين",              sortable: true }
  ];

  let extraColumns = [];

  function rebuildExtraColumnsFromEmployees() {
    const set = new Set(extraColumns);
    employees.forEach(emp => {
      if (emp.extra && typeof emp.extra === "object") {
        Object.keys(emp.extra).forEach(k => set.add(k));
      }
    });
    extraColumns = Array.from(set);
  }

  const bodyEl = document.body;
  const themeSelect = document.getElementById("themeSelect");

  const employeesHeaderRow = document.getElementById("employeesHeaderRow");
  const tableBody = document.getElementById("employeesTableBody");
  const totalCountSpan = document.getElementById("totalCount");
  const activeCountSpan = document.getElementById("activeCount");
  const maleCountSpan = document.getElementById("maleCount");
  const femaleCountSpan = document.getElementById("femaleCount");
  const statusStatsSpan = document.getElementById("statusStats");
  const deptStatsSpan = document.getElementById("deptStats");

  const filterForm = document.getElementById("filterForm");
  const filterName = document.getElementById("filterName");
  const filterDept = document.getElementById("filterDept");
  const filterStatus = document.getElementById("filterStatus");
  const btnReset = document.getElementById("btnReset");

  const btnAdd = document.getElementById("btnAdd");
  const btnExportExcel = document.getElementById("btnExportExcel");
  const btnImportExcel = document.getElementById("btnImportExcel");
  const importExcelFileInput = document.getElementById("importExcelFile");

  const btnExportJson = document.getElementById("btnExportJson");
  const btnImportJson = document.getElementById("btnImportJson");
  const importJsonFileInput = document.getElementById("importJsonFile");

  const btnSave = document.getElementById("btnSave");

  const dashTotalEmployees = document.getElementById("dashTotalEmployees");
  const dashActiveEmployees = document.getElementById("dashActiveEmployees");
  const dashMaleEmployees = document.getElementById("dashMaleEmployees");
  const dashFemaleEmployees = document.getElementById("dashFemaleEmployees");

  const deptReportBody = document.getElementById("deptReportBody");
  const statusReportBody = document.getElementById("statusReportBody");
  const genderMaleReport = document.getElementById("genderMaleReport");
  const genderFemaleReport = document.getElementById("genderFemaleReport");
  const genderOtherReport = document.getElementById("genderOtherReport");
  const reportTotalEmployees = document.getElementById("reportTotalEmployees");
  const reportActiveEmployees = document.getElementById("reportActiveEmployees");

  const employeeFormSection = document.getElementById("employeeFormSection");
  const employeeFormTitle = document.getElementById("employeeFormTitle");
  const employeeForm = document.getElementById("employeeForm");
  const employeeFormClose = document.getElementById("employeeFormClose");
  const employeeFormCancel = document.getElementById("employeeFormCancel");

  const empFirstNameInput = document.getElementById("empFirstName");
  const empSecondNameInput = document.getElementById("empSecondName");
  const empThirdNameInput = document.getElementById("empThirdName");
  const empFourthNameInput = document.getElementById("empFourthName");
  const empLastPromotionInput = document.getElementById("empLastPromotion");
  const empLastAnnualBonusInput = document.getElementById("empLastAnnualBonus");
  const empJobTitleInput = document.getElementById("empJobTitle");
  const empStatusInput = document.getElementById("empStatus");
  const empDeptInput = document.getElementById("empDept");
  const empJobNumberInput = document.getElementById("empJobNumber");
  const empNationalIdInput = document.getElementById("empNationalId");
  const empMotherNameInput = document.getElementById("empMotherName");
  const empGenderInput = document.getElementById("empGender");
  const empBirthDateInput = document.getElementById("empBirthDate");
  const empHireDateInput = document.getElementById("empHireDate");
  const empNotesInput = document.getElementById("empNotes");

  const empFileInput = document.getElementById("empFile");
  const empFileInfo = document.getElementById("empFileInfo");

  /* ===== Font Scale Logic (Dropdown Bottom-Right) ===== */
  const fontSizeSelect = document.getElementById("fontSizeSelect");
  function applyFontScale(scale){
    const s = Number(scale);
    const min = 0.60;
    const max = 1.25;
    const safe = (isNaN(s) ? 1 : Math.min(max, Math.max(min, s)));
    document.documentElement.style.setProperty("--font-scale", String(safe));
    localStorage.setItem("hr_font_scale", String(safe));
  }
  const savedScale = localStorage.getItem("hr_font_scale") || "1";
  applyFontScale(savedScale);
  if (fontSizeSelect) fontSizeSelect.value = savedScale;
  if (fontSizeSelect){
    fontSizeSelect.addEventListener("change", (e) => applyFontScale(e.target.value));
  }

  let formFileName = null;
  let formFileType = null;
  let formFileData = null;

  function applyTheme(themeClass) {
    bodyEl.classList.remove(
      "theme-light","theme-dark","theme-ocean","theme-sepia","theme-comfort",
      "theme-hospital-blue","theme-hospital-soft","theme-hospital-dark"
    );
    bodyEl.classList.add(themeClass);
    localStorage.setItem("hr_theme", themeClass);
  }
  themeSelect.addEventListener("change", e => applyTheme(e.target.value));
  const savedTheme = localStorage.getItem("hr_theme") || "theme-hospital-soft";
  applyTheme(savedTheme);
  themeSelect.value = savedTheme;

  const defaultStatuses = [
    "مستمر بالخدمة","إجازة","متقاعد","متدرب","منسب","منقول","إجازة طويلة","مجاز دراسياً"
  ];
  let statusSet = new Set(defaultStatuses);

  function rebuildStatusSetFromEmployees() {
    statusSet = new Set(defaultStatuses);
    employees.forEach(emp => {
      if (emp.status && String(emp.status).trim() !== "") {
        statusSet.add(String(emp.status).trim());
      }
    });
  }

  function renderStatusOptions() {
    const currentFilterValue = filterStatus.value;
    const currentEmpStatusValue = empStatusInput.value;

    const allStatuses = Array.from(statusSet).filter(Boolean).sort((a, b) => a.localeCompare(b, "ar"));

    filterStatus.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "الكل";
    filterStatus.appendChild(optAll);

    allStatuses.forEach(st => {
      const opt = document.createElement("option");
      opt.value = st;
      opt.textContent = st;
      filterStatus.appendChild(opt);
    });

    empStatusInput.innerHTML = "";
    allStatuses.forEach(st => {
      const opt = document.createElement("option");
      opt.value = st;
      opt.textContent = st;
      empStatusInput.appendChild(opt);
    });

    if (currentFilterValue && allStatuses.includes(currentFilterValue)) filterStatus.value = currentFilterValue;
    if (currentEmpStatusValue && allStatuses.includes(currentEmpStatusValue)) empStatusInput.value = currentEmpStatusValue;
    else if (!empStatusInput.value && allStatuses.length) empStatusInput.value = "مستمر بالخدمة";
  }

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const day = String(d.getDate()).padStart(2, "0");
    const theMonth = String(d.getMonth() + 1).padStart(2, "0");
    const year = d.getFullYear();
    return `${day}/${theMonth}/${year}`;
  }

  function ensureNameParts(emp) {
    if (emp._nameNormalized) return;
    const parts = (emp.fullName || "").trim().split(/\s+/);
    if (!emp.firstName && parts[0]) emp.firstName = parts[0];
    if (!emp.secondName && parts[1]) emp.secondName = parts[1];
    if (!emp.thirdName && parts[2]) emp.thirdName = parts[2];
    if (!emp.fourthName && parts[3]) emp.fourthName = parts[3];
    emp._nameNormalized = true;
  }

  function getEmployeeFullName(emp) {
    ensureNameParts(emp);
    if (emp.fullName) return emp.fullName;
    const parts = [emp.firstName||"", emp.secondName||"", emp.thirdName||"", emp.fourthName||""].filter(Boolean);
    return parts.join(" ");
  }

  function normalizeDateCell(value) {
    if (!value) return "";
    if (value instanceof Date) {
      const y = value.getFullYear();
      const m = String(value.getMonth() + 1).padStart(2, "0");
      const d = String(value.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    if (typeof value === "number" && typeof XLSX !== "undefined" && XLSX.SSF && XLSX.SSF.parse_date_code) {
      const o = XLSX.SSF.parse_date_code(value);
      if (o) {
        const y = o.y;
        const m = String(o.m).padStart(2, "0");
        const d = String(o.d).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }
    }
    if (typeof value === "string") {
      const v = value.trim();
      if (!v) return "";
      const d = new Date(v);
      if (!isNaN(d.getTime())) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${dd}`;
      }
      return v;
    }
    return "";
  }

  function calculateEmployeeStats(list) {
    const stats = { total: list.length, active: 0, male: 0, female: 0, other: 0, byStatus: {}, byDept: {} };
    list.forEach(emp => {
      if (emp.status === "مستمر بالخدمة") stats.active++;
      const st = emp.status || "غير محدد";
      const dept = emp.department || "غير محدد";
      stats.byStatus[st] = (stats.byStatus[st] || 0) + 1;
      stats.byDept[dept] = (stats.byDept[dept] || 0) + 1;

      const g = emp.gender || "";
      if (g === "ذكر") stats.male++;
      else if (g === "أنثى") stats.female++;
      else stats.other++;
    });
    return stats;
  }

  function renderEmployeeStats(list) {
    const s = calculateEmployeeStats(list);

    totalCountSpan.textContent = s.total;
    activeCountSpan.textContent = s.active;
    maleCountSpan.textContent = s.male;
    femaleCountSpan.textContent = s.female;

    dashTotalEmployees.textContent = s.total;
    dashActiveEmployees.textContent = s.active;
    dashMaleEmployees.textContent = s.male;
    dashFemaleEmployees.textContent = s.female;

    reportTotalEmployees.textContent = s.total;
    reportActiveEmployees.textContent = s.active;

    if (statusStatsSpan) statusStatsSpan.textContent = Object.entries(s.byStatus).map(([k, v]) => `${k}: ${v}`).join(" | ");
    if (deptStatsSpan) deptStatsSpan.textContent = Object.entries(s.byDept).map(([k, v]) => `${k}: ${v}`).join(" | ");

    deptReportBody.innerHTML = "";
    Object.entries(s.byDept).forEach(([dept, count]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${dept}</td><td>${count}</td>`;
      deptReportBody.appendChild(tr);
    });

    statusReportBody.innerHTML = "";
    Object.entries(s.byStatus).forEach(([st, count]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${st}</td><td>${count}</td>`;
      statusReportBody.appendChild(tr);
    });

    genderMaleReport.textContent = s.male;
    genderFemaleReport.textContent = s.female;
    genderOtherReport.textContent = s.other;
  }

  function renderEmployeeHeader() {
    employeesHeaderRow.innerHTML = "";

    baseColumns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col.label;
      if (col.sortable) {
        th.classList.add("sortable");
        th.dataset.sortKey = col.key;
      }
      employeesHeaderRow.appendChild(th);
    });

    extraColumns.forEach(colName => {
      const th = document.createElement("th");
      th.textContent = colName;
      th.classList.add("sortable");
      th.dataset.sortKey = "extra:" + colName;
      employeesHeaderRow.appendChild(th);
    });

    const actionsTh = document.createElement("th");
    actionsTh.className = "text-center";
    actionsTh.textContent = "إجراءات";
    employeesHeaderRow.appendChild(actionsTh);

    setupSortHandlers();
    updateSortIndicators();
  }

  function renderEmployees(list) {
    tableBody.innerHTML = "";

    list.forEach((emp, i) => {
      ensureNameParts(emp);
      const tr = document.createElement("tr");

      const statusClass =
        emp.status === "مستمر بالخدمة" ? "bg-success" :
        emp.status && emp.status.includes("إجازة") ? "bg-info" :
        emp.status === "متقاعد" ? "bg-secondary" :
        emp.status === "منقول" ? "bg-warning" :
        "bg-primary";

      let rowHtml = `
        <td class="text-center">${i + 1}</td>
        <td>${emp.firstName || ""}</td>
        <td>${emp.secondName || ""}</td>
        <td>${emp.thirdName || ""}</td>
        <td>${emp.fourthName || ""}</td>
        <td class="text-center">${formatDate(emp.lastPromotion)}</td>
        <td class="text-center">${formatDate(emp.lastAnnualBonus)}</td>
        <td>${emp.jobTitle || ""}</td>
        <td class="text-center"><span class="badge ${statusClass} badge-status">${emp.status || ""}</span></td>
        <td>${emp.notes || ""}</td>
        <td>${emp.department || ""}</td>
        <td class="text-center">${emp.jobNumber || ""}</td>
        <td class="text-center">${emp.nationalId || ""}</td>
        <td>${emp.motherName || ""}</td>
        <td class="text-center">${emp.gender || ""}</td>
        <td class="text-center">${formatDate(emp.birthDate)}</td>
        <td class="text-center">${formatDate(emp.hireDate)}</td>
      `;

      const extra = emp.extra || {};
      extraColumns.forEach(colName => {
        const val = extra[colName] != null ? extra[colName] : "";
        rowHtml += `<td>${val}</td>`;
      });

      const hasFile = !!emp.fileData;
      rowHtml += `
        <td class="text-center">
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="editEmployee(${emp.id})">تعديل</button>
          <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteEmployee(${emp.id})">حذف</button>
          <button class="btn btn-sm btn-outline-primary" onclick="downloadEmployeeFile(${emp.id})"
            ${hasFile ? "" : "disabled"}>
            ملف
          </button>
        </td>
      `;

      tr.innerHTML = rowHtml;
      tableBody.appendChild(tr);
    });

    renderEmployeeStats(list);
  }

  function parseMaybeNumber(val) {
    if (val == null) return null;
    const s = String(val).replace(/\s+/g, "");
    if (!/^\d+(\.\d+)?$/.test(s)) return null;
    return Number(s);
  }

  function parseMaybeDate(val) {
    if (!val) return null;
    const d = new Date(val);
    if (isNaN(d.getTime())) return null;
    return d.getTime();
  }

  function getSortValue(emp, key) {
    ensureNameParts(emp);
    if (key.startsWith("extra:")) {
      const colName = key.slice(6);
      return (emp.extra && emp.extra[colName]) || "";
    }
    switch (key) {
      case "index": return emp.id;
      case "firstName": return emp.firstName || "";
      case "secondName": return emp.secondName || "";
      case "thirdName": return emp.thirdName || "";
      case "fourthName": return emp.fourthName || "";
      case "lastPromotion": return emp.lastPromotion || "";
      case "lastAnnualBonus": return emp.lastAnnualBonus || "";
      case "jobTitle": return emp.jobTitle || "";
      case "status": return emp.status || "";
      case "notes": return emp.notes || "";
      case "department": return emp.department || "";
      case "jobNumber": return emp.jobNumber || "";
      case "nationalId": return emp.nationalId || "";
      case "motherName": return emp.motherName || "";
      case "gender": return emp.gender || "";
      case "birthDate": return emp.birthDate || "";
      case "hireDate": return emp.hireDate || "";
      default: return "";
    }
  }

  function sortEmployees(key, dir) {
    const factor = dir === "asc" ? 1 : -1;
    currentView.sort((a, b) => {
      const va = getSortValue(a, key);
      const vb = getSortValue(b, key);
      if (va == null && vb == null) return 0;
      if (va == null) return 1 * factor;
      if (vb == null) return -1 * factor;

      const na = parseMaybeNumber(va);
      const nb = parseMaybeNumber(vb);
      if (na !== null && nb !== null) return (na - nb) * factor;

      const da = parseMaybeDate(va);
      const db = parseMaybeDate(vb);
      if (da !== null && db !== null) return (da - db) * factor;

      return String(va).localeCompare(String(vb), "ar", { numeric: true }) * factor;
    });

    renderEmployees(currentView);
  }

  function updateSortIndicators() {
    const headers = document.querySelectorAll(".employee-table thead th.sortable");
    headers.forEach(th => {
      th.classList.remove("sort-asc", "sort-desc");
      const key = th.getAttribute("data-sort-key");
      if (key && key === currentSort.key) {
        th.classList.add(currentSort.dir === "asc" ? "sort-asc" : "sort-desc");
      }
    });
  }

  function setupSortHandlers() {
    const headerCells = document.querySelectorAll(".employee-table thead th.sortable");
    headerCells.forEach(th => {
      th.onclick = () => {
        const key = th.getAttribute("data-sort-key");
        if (!key) return;
        if (currentSort.key === key) currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
        else { currentSort.key = key; currentSort.dir = "asc"; }
        sortEmployees(currentSort.key, currentSort.dir);
        updateSortIndicators();
      };
    });
  }

  function applyEmployeeFilters() {
    const nameVal = filterName.value.trim();
    const deptVal = filterDept.value;
    const statusVal = filterStatus.value;

    currentView = employees.filter(emp => {
      const mName = !nameVal || getEmployeeFullName(emp).includes(nameVal);
      const mDept = !deptVal || emp.department === deptVal;
      const mStatus = !statusVal || emp.status === statusVal;
      return mName && mDept && mStatus;
    });
    if (currentSort.key) sortEmployees(currentSort.key, currentSort.dir);
    else renderEmployees(currentView);
  }
  filterForm.addEventListener("submit", e => { e.preventDefault(); applyEmployeeFilters(); });
  btnReset.addEventListener("click", () => {
    filterName.value = "";
    filterDept.value = "";
    filterStatus.value = "";
    currentView = [...employees];
    currentSort = { key: null, dir: "asc" };
    updateSortIndicators();
    renderEmployees(currentView);
  });

  function clearEmployeeForm() {
    empFirstNameInput.value = "";
    empSecondNameInput.value = "";
    empThirdNameInput.value = "";
    empFourthNameInput.value = "";
    empLastPromotionInput.value = "";
    empLastAnnualBonusInput.value = "";
    empJobTitleInput.value = "";
    empDeptInput.value = "";
    empJobNumberInput.value = "";
    empNationalIdInput.value = "";
    empMotherNameInput.value = "";
    empGenderInput.value = "";
    empBirthDateInput.value = "";
    empHireDateInput.value = "";
    empNotesInput.value = "";
    empFileInput.value = "";
    empFileInfo.textContent = "";
    formFileName = formFileType = formFileData = null;
    if (empStatusInput.options.length) empStatusInput.value = "مستمر بالخدمة";
  }

  function fillEmployeeForm(emp) {
    ensureNameParts(emp);
    empFirstNameInput.value = emp.firstName || "";
    empSecondNameInput.value = emp.secondName || "";
    empThirdNameInput.value = emp.thirdName || "";
    empFourthNameInput.value = emp.fourthName || "";

    empLastPromotionInput.value = emp.lastPromotion || "";
    empLastAnnualBonusInput.value = emp.lastAnnualBonus || "";

    empJobTitleInput.value = emp.jobTitle || "";
    empStatusInput.value = emp.status || "مستمر بالخدمة";
    empDeptInput.value = emp.department || "";
    empJobNumberInput.value = emp.jobNumber || "";
    empNationalIdInput.value = emp.nationalId || "";
    empMotherNameInput.value = emp.motherName || "";
    empGenderInput.value = emp.gender || "";
    empBirthDateInput.value = emp.birthDate || "";
    empHireDateInput.value = emp.hireDate || "";
    empNotesInput.value = emp.notes || "";

    empFileInput.value = "";
    formFileName = emp.fileName || null;
    formFileType = emp.fileType || null;
    formFileData = emp.fileData || null;
    empFileInfo.textContent = formFileName ? ("ملف محفوظ: " + formFileName) : "";
  }

  function openEmployeeForm(mode, emp) {
    if (mode === "add") {
      editingEmployeeId = null;
      employeeFormTitle.textContent = "إضافة موظف جديد";
      clearEmployeeForm();
    } else if (mode === "edit" && emp) {
      editingEmployeeId = emp.id;
      employeeFormTitle.textContent = "تعديل بيانات الموظف";
      fillEmployeeForm(emp);
    }
    employeeFormSection.classList.remove("d-none");
  }
  function closeEmployeeForm() { employeeFormSection.classList.add("d-none"); }
  employeeFormClose.addEventListener("click", closeEmployeeForm);
  employeeFormCancel.addEventListener("click", closeEmployeeForm);

  btnAdd.addEventListener("click", () => openEmployeeForm("add", null));

  empFileInput.addEventListener("change", () => {
    const file = empFileInput.files[0];
    if (!file) {
      formFileName = formFileType = formFileData = null;
      empFileInfo.textContent = "";
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      formFileName = file.name;
      formFileType = file.type || "application/octet-stream";
      formFileData = e.target.result;
      empFileInfo.textContent = "سيتم حفظ الملف: " + formFileName;
    };
    reader.readAsDataURL(file);
  });

  employeeForm.addEventListener("submit", e => {
    e.preventDefault();

    const firstName = empFirstNameInput.value.trim();
    const secondName = empSecondNameInput.value.trim();
    const thirdName = empThirdNameInput.value.trim();
    const fourthName = empFourthNameInput.value.trim();
    const jobTitle = empJobTitleInput.value.trim();
    const status = empStatusInput.value;
    const dept = empDeptInput.value.trim();
    const jobNumber = empJobNumberInput.value.trim();

    if (!firstName || !jobTitle || !dept || !jobNumber) {
      alert("الرجاء تعبئة الحقول الأساسية (الاسم الأول، العنوان الوظيفي، الدائرة، الرقم الوظيفي).");
      return;
    }

    const fullName = [firstName, secondName, thirdName, fourthName].filter(Boolean).join(" ");

    let fileNameToSave = formFileName;
    let fileTypeToSave = formFileType;
    let fileDataToSave = formFileData;
    if (editingEmployeeId !== null && fileNameToSave == null) {
      const oldEmp = employees.find(e => e.id === editingEmployeeId);
      if (oldEmp) {
        fileNameToSave = oldEmp.fileName || null;
        fileTypeToSave = oldEmp.fileType || null;
        fileDataToSave = oldEmp.fileData || null;
      }
    }

    const commonData = {
      fullName,
      firstName,
      secondName,
      thirdName,
      fourthName,
      lastPromotion: empLastPromotionInput.value || "",
      lastAnnualBonus: empLastAnnualBonusInput.value || "",
      jobTitle,
      status,
      department: dept,
      jobNumber,
      nationalId: empNationalIdInput.value.trim(),
      motherName: empMotherNameInput.value.trim(),
      gender: empGenderInput.value,
      birthDate: empBirthDateInput.value,
      hireDate: empHireDateInput.value,
      notes: empNotesInput.value.trim(),
      fileName: fileNameToSave,
      fileType: fileTypeToSave,
      fileData: fileDataToSave
    };

    if (editingEmployeeId === null) {
      const newId = employees.length ? Math.max(...employees.map(e => e.id)) + 1 : 1;
      const newEmp = { id: newId, extra: {}, ...commonData };
      employees.push(newEmp);
      alert("تمت إضافة الموظف بنجاح.");
    } else {
      const emp = employees.find(e => e.id === editingEmployeeId);
      if (!emp) { alert("لم يتم العثور على الموظف."); return; }
      Object.assign(emp, commonData);
      if (!emp.extra) emp.extra = {};
      alert("تم تحديث بيانات الموظف.");
    }

    saveDataToStorage();
    rebuildStatusSetFromEmployees();
    rebuildExtraColumnsFromEmployees();
    renderStatusOptions();
    renderEmployeeHeader();
    currentView = [...employees];
    if (currentSort.key) sortEmployees(currentSort.key, currentSort.dir);
    else renderEmployees(currentView);
    closeEmployeeForm();
  });

  btnSave.addEventListener("click", () => {
    saveDataToStorage();
    alert("تم حفظ بيانات الموظفين في هذا الجهاز.");
  });

  btnExportExcel.addEventListener("click", () => {
    const list = currentView;
    if (!list.length) { alert("لا توجد بيانات لتصديرها."); return; }

    const header = [
      "الأسم الاول","الأسم الثاني","الأسم الثالث","الأسم الرابع",
      "اخر ترفيع","اخر علاوة سنوية","العنوان الوظيفي","الحالة الوظيفية","الملاحظات",
      "أسم الدائرة / مبنى الوزارة","الرقم الوظيفي","الرقم الوطني","أسم الأم الثلاثي",
      "الجنس","تاريخ التولد","تاريخ التعيين",
      ...extraColumns
    ];

    const rows = list.map(emp => {
      ensureNameParts(emp);
      const extra = emp.extra || {};
      return [
        emp.firstName||"", emp.secondName||"", emp.thirdName||"", emp.fourthName||"",
        emp.lastPromotion||"", emp.lastAnnualBonus||"", emp.jobTitle||"", emp.status||"",
        emp.notes||"", emp.department||"", emp.jobNumber||"", emp.nationalId||"",
        emp.motherName||"", emp.gender||"", emp.birthDate||"", emp.hireDate||"",
        ...extraColumns.map(colName => extra[colName] != null ? extra[colName] : "")
      ];
    });

    const csv = [header, ...rows]
      .map(row => row.map(f => `"${String(f ?? "").replace(/"/g,'""')}"`).join(","))
      .join("\r\n");

    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "employees.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  btnImportExcel.addEventListener("click", () => { importExcelFileInput.click(); });

  importExcelFileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = event => {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

      importEmployeesFromSheet(rows);
      importExcelFileInput.value = "";
    };
    reader.readAsArrayBuffer(file);
  });

  function importEmployeesFromSheet(rows) {
    if (!rows || rows.length < 2) { alert("الملف لا يحتوي بيانات موظفين."); return; }

    const header = rows[0].map(h => (h || "").toString().trim());

    const colNames = {
      first:"الأسم الاول", second:"الأسم الثاني", third:"الأسم الثالث", fourth:"الأسم الرابع",
      lastPromotion:"اخر ترفيع", lastPromotion2:"آخر ترفيع",
      lastAnnual:"اخر علاوة سنوية", lastAnnual2:"علاوة سنوية",
      jobTitle:"العنوان الوظيفي", status:"الحالة الوظيفية", notes:"الملاحظات",
      dept:"أسم الدائرة / مبنى الوزارة", jobNumber:"الرقم الوظيفي", nationalId:"الرقم الوطني",
      motherName:"أسم الأم الثلاثي", gender:"الجنس", birthDate:"تاريخ التولد", hireDate:"تاريخ التعيين"
    };

    function idx(name){ return header.indexOf(name); }

    const indices = {
      first: idx(colNames.first),
      second: idx(colNames.second),
      third: idx(colNames.third),
      fourth: idx(colNames.fourth),
      lastPromotion: (() => { const i1 = idx(colNames.lastPromotion); if (i1 !== -1) return i1; return idx(colNames.lastPromotion2); })(),
      lastAnnual: (() => { const i1 = idx(colNames.lastAnnual); if (i1 !== -1) return i1; return idx(colNames.lastAnnual2); })(),
      jobTitle: idx(colNames.jobTitle),
      status: idx(colNames.status),
      notes: idx(colNames.notes),
      dept: idx(colNames.dept),
      jobNumber: idx(colNames.jobNumber),
      nationalId: idx(colNames.nationalId),
      motherName: idx(colNames.motherName),
      gender: idx(colNames.gender),
      birthDate: idx(colNames.birthDate),
      hireDate: idx(colNames.hireDate)
    };

    const foundCount = Object.values(indices).filter(i => i !== -1).length;
    if (foundCount === 0) { importByFixedOrder(rows); return; }

    const newEmployees = [];

    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (!row || row.every(cell => cell === null || cell === undefined || String(cell).trim() === "")) continue;

      const firstName  = String(row[indices.first]  ?? "").trim();
      const secondName = String(row[indices.second] ?? "").trim();
      const thirdName  = String(row[indices.third]  ?? "").trim();
      const fourthName = String(row[indices.fourth] ?? "").trim();

      const lastPromotionRaw = indices.lastPromotion !== -1 ? row[indices.lastPromotion] : "";
      const lastAnnualRaw    = indices.lastAnnual   !== -1 ? row[indices.lastAnnual]   : "";

      const jobTitle   = String(row[indices.jobTitle]   ?? "").trim();
      const status     = String(row[indices.status]     ?? "").trim();
      const notes      = String(row[indices.notes]      ?? "").trim();
      const dept       = String(row[indices.dept]       ?? "").trim();
      const jobNumber  = String(row[indices.jobNumber]  ?? "").trim();
      const nationalId = String(row[indices.nationalId] ?? "").trim();
      const motherName = String(row[indices.motherName] ?? "").trim();
      const gender     = String(row[indices.gender]     ?? "").trim();

      const birthDateRaw = row[indices.birthDate];
      const hireDateRaw  = row[indices.hireDate];

      const birthDate = normalizeDateCell(birthDateRaw);
      const hireDate  = normalizeDateCell(hireDateRaw);
      const lastPromotion = normalizeDateCell(lastPromotionRaw);
      const lastAnnualBonus = normalizeDateCell(lastAnnualRaw);

      if (!firstName && !jobTitle && !jobNumber) continue;

      const fullName = [firstName, secondName, thirdName, fourthName].filter(Boolean).join(" ");

      const usedIndices = new Set(Object.values(indices).filter(i => i !== -1));
      const extra = {};
      header.forEach((colTitle, colIndex) => {
        if (usedIndices.has(colIndex)) return;
        const val = row[colIndex];
        if (val === null || val === undefined) return;
        const strVal = String(val).trim();
        if (!strVal) return;
        extra[colTitle] = strVal;
      });

      newEmployees.push({
        id: 0,
        fullName,
        firstName, secondName, thirdName, fourthName,
        lastPromotion, lastAnnualBonus,
        jobTitle, status,
        department: dept,
        jobNumber, nationalId, motherName, gender,
        birthDate, hireDate,
        notes,
        extra,
        fileName: null, fileType: null, fileData: null
      });
    }

    if (!newEmployees.length) { alert("لم يتم العثور على أي صفوف صالحة للموظفين في الملف."); return; }
    mergeImportedEmployees(newEmployees);
  }

  function importByFixedOrder(rows) {
    const newEmployees = [];

    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (!row || row.every(cell => cell === null || cell === undefined || String(cell).trim() === "")) continue;

      const firstName  = String(row[0]  ?? "").trim();
      const secondName = String(row[1]  ?? "").trim();
      const thirdName  = String(row[2]  ?? "").trim();
      const fourthName = String(row[3]  ?? "").trim();
      const lastPromotionRaw = row[4];
      const lastAnnualRaw    = row[5];
      const jobTitle   = String(row[6]  ?? "").trim();
      const status     = String(row[7]  ?? "").trim();
      const notes      = String(row[8]  ?? "").trim();
      const dept       = String(row[9]  ?? "").trim();
      const jobNumber  = String(row[10] ?? "").trim();
      const nationalId = String(row[11] ?? "").trim();
      const motherName = String(row[12] ?? "").trim();
      const gender     = String(row[13] ?? "").trim();
      const birthDateRaw = row[14];
      const hireDateRaw  = row[15];

      const birthDate = normalizeDateCell(birthDateRaw);
      const hireDate  = normalizeDateCell(hireDateRaw);
      const lastPromotion = normalizeDateCell(lastPromotionRaw);
      const lastAnnualBonus = normalizeDateCell(lastAnnualRaw);

      if (!firstName && !jobTitle && !jobNumber) continue;

      const fullName = [firstName, secondName, thirdName, fourthName].filter(Boolean).join(" ");

      newEmployees.push({
        id: 0,
        fullName,
        firstName, secondName, thirdName, fourthName,
        lastPromotion, lastAnnualBonus,
        jobTitle, status,
        department: dept,
        jobNumber, nationalId, motherName, gender,
        birthDate, hireDate,
        notes,
        extra: {},
        fileName: null, fileType: null, fileData: null
      });
    }

    if (!newEmployees.length) {
      alert("الملف لا يحتوي بيانات موظفين بالترتيب المتوقع للأعمدة.");
      return;
    }

    mergeImportedEmployees(newEmployees);
  }

  function mergeImportedEmployees(newEmployees) {
    const replace = confirm("تم العثور على بيانات موظفين في الملف.\nهل تريد استبدال جميع الموظفين الحاليين بالملف المستورد؟\n(موافق = استبدال الكل، إلغاء = إضافة فوق الموجودين)");
    if (replace) employees.length = 0;

    let maxId = employees.length ? Math.max(...employees.map(e => e.id)) : 0;
    newEmployees.forEach(emp => { emp.id = ++maxId; employees.push(emp); });

    saveDataToStorage();
    rebuildStatusSetFromEmployees();
    rebuildExtraColumnsFromEmployees();
    renderStatusOptions();
    renderEmployeeHeader();
    currentView = [...employees];
    if (currentSort.key) sortEmployees(currentSort.key, currentSort.dir);
    else renderEmployees(currentView);
    alert("تم استيراد الموظفين من الملف بنجاح.");
  }

  btnExportJson.addEventListener("click", () => {
    if (!employees.length) { alert("لا توجد بيانات لتصديرها."); return; }
    const data = JSON.stringify(employees, null, 2);
    const blob = new Blob([data], { type: "application/json;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "employees.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  btnImportJson.addEventListener("click", () => { importJsonFileInput.click(); });

  importJsonFileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!Array.isArray(data)) {
          alert("صيغة ملف JSON غير صحيحة، يجب أن يكون مصفوفة من الموظفين.");
          return;
        }
        const newEmployees = data.map(item => {
          const firstName  = item.firstName  || "";
          const secondName = item.secondName || "";
          const thirdName  = item.thirdName  || "";
          const fourthName = item.fourthName || "";
          const fullName = item.fullName || [firstName, secondName, thirdName, fourthName].filter(Boolean).join(" ");
          return {
            id: 0,
            fullName,
            firstName, secondName, thirdName, fourthName,
            lastPromotion: item.lastPromotion || "",
            lastAnnualBonus: item.lastAnnualBonus || "",
            jobTitle: item.jobTitle || "",
            status: item.status || "مستمر بالخدمة",
            department: item.department || "",
            jobNumber: item.jobNumber || "",
            nationalId: item.nationalId || "",
            motherName: item.motherName || "",
            gender: item.gender || "",
            birthDate: item.birthDate || "",
            hireDate: item.hireDate || "",
            notes: item.notes || "",
            extra: item.extra || {},
            fileName: item.fileName || null,
            fileType: item.fileType || null,
            fileData: item.fileData || null
          };
        });
        if (!newEmployees.length) { alert("ملف JSON لا يحتوي بيانات موظفين صالحة."); return; }
        mergeImportedEmployees(newEmployees);
      } catch (err) {
        console.error(err);
        alert("تعذر قراءة ملف JSON. تأكد من أن الصيغة صحيحة.");
      } finally {
        importJsonFileInput.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  });

  window.editEmployee = id => {
    const emp = employees.find(e => e.id === id);
    if (!emp) { alert("لم يتم العثور على الموظف."); return; }
    openEmployeeForm("edit", emp);
  };

  window.deleteEmployee = id => {
    if (!confirm("هل أنت متأكد من حذف هذا الموظف؟")) return;
    const idx = employees.findIndex(e => e.id === id);
    if (idx === -1) { alert("لم يتم العثور على الموظف."); return; }
    employees.splice(idx, 1);
    if (editingEmployeeId === id) editingEmployeeId = null;
    saveDataToStorage();
    rebuildStatusSetFromEmployees();
    rebuildExtraColumnsFromEmployees();
    renderStatusOptions();
    renderEmployeeHeader();
    currentView = [...employees];
    if (currentSort.key) sortEmployees(currentSort.key, currentSort.dir);
    else renderEmployees(currentView);
    alert("تم حذف الموظف.");
  };

  function dataURLToBlob(dataURL) {
    const parts = dataURL.split(",");
    const meta = parts[0];
    const base64 = parts[1];
    const mime = meta.match(/data:(.*);base64/)[1] || "application/octet-stream";
    const binary = atob(base64);
    const len = binary.length;
    const u8 = new Uint8Array(len);
    for (let i = 0; i < len; i++) u8[i] = binary.charCodeAt(i);
    return new Blob([u8], { type: mime });
  }

  window.downloadEmployeeFile = id => {
    const emp = employees.find(e => e.id === id);
    if (!emp || !emp.fileData) { alert("لا يوجد ملف محفوظ لهذا الموظف."); return; }
    try {
      const blob = dataURLToBlob(emp.fileData);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = emp.fileName || "employee_file";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error(e);
      alert("تعذر تحميل الملف.");
    }
  };

  const navLinks = document.querySelectorAll(".sidebar .nav-link");
  function showSection(sectionId) {
    const ids = ["dashboard","employees","reports"];
    ids.forEach(id => {
      const sec = document.getElementById(id);
      if (!sec) return;
      if (id === sectionId) sec.classList.remove("d-none");
      else sec.classList.add("d-none");
    });
    navLinks.forEach(link => {
      const href = link.getAttribute("href") || "";
      if (!href.startsWith("#")) return;
      const targetId = href.substring(1);
      link.classList.toggle("active", targetId === sectionId);
    });
    localStorage.setItem(STORAGE_KEYS.section, sectionId);
    window.scrollTo({ top: 0, behavior: "auto" });
  }

  navLinks.forEach(link => {
    const href = link.getAttribute("href") || "";
    if (!href.startsWith("#")) return;
    const targetId = href.substring(1);
    if (["dashboard","employees","reports"].includes(targetId)) {
      link.addEventListener("click", e => { e.preventDefault(); showSection(targetId); });
    }
  });

  const logoutLink = Array.from(navLinks).find(l => (l.textContent || "").trim() === "تسجيل الخروج");
  if (logoutLink) {
    logoutLink.addEventListener("click", e => {
      e.preventDefault();
      alert("تم تسجيل الخروج (تجريبيًا، يمكن ربطه لاحقًا بصفحة دخول).");
    });
  }

  rebuildStatusSetFromEmployees();
  rebuildExtraColumnsFromEmployees();
  renderStatusOptions();
  renderEmployeeHeader();
  currentView = [...employees];
  renderEmployees(currentView);
  updateSortIndicators();

  saveDataToStorage();

  const savedSectionId = localStorage.getItem(STORAGE_KEYS.section) || "dashboard";
  showSection(savedSectionId);
</script>
</body>
</html>
