<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة الموظفين</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- تطبيق الثيم المحفوظ قبل تحميل الـ CSS لمنع الوميض -->
    <script>
        (function () {
            try {
                var savedTheme = localStorage.getItem('hrTheme') || 'theme-default';
                document.documentElement.setAttribute('data-theme', savedTheme);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'theme-default');
            }
        })();
    </script>

    <!-- مكتبة Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* متغيرات الألوان حسب الثيم */
        :root {
            --sidebar-bg: #111827;
            --sidebar-bg-active: #1f2937;
            --sidebar-text: #e5e7eb;
            --sidebar-text-muted: #9ca3af;

            --body-bg: #f3f4f6;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;

            --accent: #2563eb;
            --accent-soft: rgba(37, 99, 235, 0.08);
            --accent-strong: #1d4ed8;

            --text-main: #111827;
            --text-muted: #6b7280;

            --danger: #dc2626;
            --success: #16a34a;
            --warning: #d97706;
            --badge-bg: #e5e7eb;

            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --input-focus: #2563eb;

            --table-header-bg: #e5f0ff;
            --table-row-hover: #eff6ff;
        }

        :root[data-theme="theme-default"] {
            --sidebar-bg: #111827;
            --sidebar-bg-active: #1f2937;
            --accent: #2563eb;
            --accent-strong: #1d4ed8;
            --body-bg: #f3f4f6;
            --card-bg: #ffffff;
        }

        :root[data-theme="theme-blue"] {
            --sidebar-bg: #0f172a;
            --sidebar-bg-active: #1e293b;
            --accent: #0ea5e9;
            --accent-strong: #0284c7;
            --body-bg: #e0f2fe;
            --card-bg: #f9fafb;
        }

        :root[data-theme="theme-slate"] {
            --sidebar-bg: #111827;
            --sidebar-bg-active: #020617;
            --accent: #64748b;
            --accent-strong: #475569;
            --body-bg: #e5e7eb;
            --card-bg: #f9fafb;
        }

        :root[data-theme="theme-ocean"] {
            --sidebar-bg: #022c22;
            --sidebar-bg-active: #064e3b;
            --accent: #0d9488;
            --accent-strong: #0f766e;
            --body-bg: #ecfeff;
            --card-bg: #f9fafb;
        }

        :root[data-theme="theme-olive"] {
            --sidebar-bg: #1a2e05;
            --sidebar-bg-active: #365314;
            --accent: #65a30d;
            --accent-strong: #4d7c0f;
            --body-bg: #f7fee7;
            --card-bg: #fefce8;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Tahoma", "Segoe UI", system-ui, -apple-system, sans-serif;
            background: var(--body-bg);
            color: var(--text-main);
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .sidebar-title {
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            width: 100%;
        }

        .sidebar-badge {
            font-size: 0.7rem;
            border-radius: 999px;
            border: 1px solid rgba(209, 213, 219, 0.5);
            padding: 0.15rem 0.4rem;
            background: rgba(31, 41, 55, 0.7);
        }

        .sidebar-nav {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .sidebar-nav-item {
            margin-bottom: 0.4rem;
        }

        .sidebar-nav-link {
            display: block;
            padding: 0.55rem 0.8rem;
            border-radius: 0.7rem;
            color: var(--sidebar-text);
            text-decoration: none;
            font-size: 0.95rem;
            transition: background 0.15s ease, color 0.15s ease, transform 0.05s ease;
            cursor: pointer;
        }

        .sidebar-nav-link:hover {
            background: rgba(55, 65, 81, 0.9);
            transform: translateX(-2px);
        }

        .sidebar-nav-link.active {
            background: var(--sidebar-bg-active);
            color: #fff;
            font-weight: 600;
        }

        .sidebar-footer {
            margin-top: auto;
            font-size: 0.75rem;
            color: var(--sidebar-text-muted);
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(55, 65, 81, 0.7);
        }

        .main {
            flex: 1;
            padding: 1.5rem 1.8rem;
            overflow: hidden;
        }

        .main-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            gap: 0.75rem;
        }

        .main-title-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .main-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .main-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        select,
        input[type="text"],
        input[type="date"] {
            font-family: inherit;
            border-radius: 0.5rem;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            min-width: 120px;
        }

        select:focus,
        input[type="text"]:focus,
        input[type="date"]:focus {
            outline: 2px solid var(--input-focus);
            outline-offset: 1px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--accent);
            color: #fff;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent-strong);
        }

        .btn-secondary {
            background: #fff;
            color: var(--text-main);
            border-color: var(--input-border);
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--danger);
            border-color: #fecaca;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border-color: transparent;
        }

        .btn-ghost:hover {
            background: rgba(148, 163, 184, 0.15);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.7rem;
            border: 1px solid transparent;
            background: var(--badge-bg);
        }

        .badge-success {
            background: rgba(22, 163, 74, 0.08);
            color: var(--success);
            border-color: rgba(22, 163, 74, 0.4);
        }

        .badge-warning {
            background: rgba(234, 179, 8, 0.08);
            color: var(--warning);
            border-color: rgba(234, 179, 8, 0.4);
        }

        .badge-muted {
            background: rgba(148, 163, 184, 0.15);
            color: #4b5563;
            border-color: rgba(148, 163, 184, 0.4);
        }

        .page-section {
            display: none;
            height: calc(100vh - 100px);
            overflow: hidden;
        }

        .page-section.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border-radius: 0.9rem;
            border: 1px solid var(--card-border);
            padding: 1rem 1.2rem;
            box-shadow: 0 4px 18px rgba(15, 23, 42, 0.06);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .toolbar-right {
            margin-inline-start: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.6rem;
        }

        .filters-row > * {
            flex: 1 1 170px;
        }

        .table-wrapper {
            border-radius: 0.8rem;
            border: 1px solid var(--card-border);
            overflow: auto;
            max-height: calc(100vh - 230px);
            background: #fff;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 1200px;
            font-size: 0.8rem;
        }

        thead {
            background: var(--table-header-bg);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        th,
        td {
            padding: 0.45rem 0.6rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            font-size: 0.75rem;
            color: #4b5563;
            user-select: none;
            position: relative;
        }

        th.sortable {
            cursor: pointer;
        }

        th.sortable::after {
            content: "⇅";
            font-size: 0.7rem;
            opacity: 0.3;
            margin-right: 0.15rem;
        }

        th.sortable.sorted-asc::after {
            content: "↑";
            opacity: 0.8;
        }

        th.sortable.sorted-desc::after {
            content: "↓";
            opacity: 0.8;
        }

        tbody tr:hover {
            background: var(--table-row-hover);
        }

        .table-actions {
            display: flex;
            gap: 0.25rem;
        }

        .table-actions .btn {
            padding-inline: 0.45rem;
            font-size: 0.75rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 0.9rem;
            padding: 0.75rem 0.9rem;
            border: 1px solid var(--card-border);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
        }

        .stat-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-top: 0.35rem;
        }

        .stat-chip {
            font-size: 0.65rem;
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent-strong);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .modal-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 1rem;
            width: min(1100px, 96vw);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--card-border);
        }

        .modal-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--body-bg);
        }

        .modal-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .modal-body {
            padding: 0.9rem 1rem 0.4rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 0.65rem 1rem 0.9rem;
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: flex-start;
            gap: 0.5rem;
        }

        .close-icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
        }

        .close-icon-btn:hover {
            background: rgba(148, 163, 184, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.6rem;
            margin-bottom: 0.4rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .form-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .form-group input,
        .form-group select {
            width: 100%;
        }

        .form-group textarea {
            width: 100%;
            min-height: 50px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--input-border);
            padding: 0.4rem 0.6rem;
        }

        .form-group textarea:focus {
            outline: 2px solid var(--input-focus);
            outline-offset: 1px;
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            inset-inline-start: 1rem;
            background: #111827;
            color: #f9fafb;
            border-radius: 999px;
            padding: 0.45rem 0.9rem;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            gap: 0.4rem;
            z-index: 60;
        }

        .toast.show {
            display: inline-flex;
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .main {
                padding-inline: 1rem;
            }

            .form-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .main-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .main {
                padding-inline: 0.75rem;
            }
        }
    </style>
</head>
<body>

<div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-badge">HR</span>
            <div class="sidebar-title">نظام الموظفين</div>
        </div>
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
                <a class="sidebar-nav-link active" data-section="dashboardSection">لوحة التحكم</a>
            </li>
            <li class="sidebar-nav-item">
                <a class="sidebar-nav-link" data-section="employeesSection">الموظفون</a>
            </li>
            <li class="sidebar-nav-item">
                <a class="sidebar-nav-link" data-section="leavesSection">الإجازات</a>
            </li>
            <li class="sidebar-nav-item">
                <a class="sidebar-nav-link" data-section="reportsSection">التقارير</a>
            </li>
            <li class="sidebar-nav-item">
                <a class="sidebar-nav-link" data-section="logoutSection">تسجيل الخروج</a>
            </li>
        </ul>

        <div class="sidebar-footer">
            نظام بسيط لإدارة الموظفين، الإجازات و التقارير في منصة واحدة.
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <header class="main-header">
            <div class="main-title-group">
                <div class="main-title">إدارة موظفي إبن سينا التعليمي</div>
                <div class="main-subtitle">تحكم، إحصائيات وتقارير من مكان واحد.</div>
            </div>
            <div class="header-controls">
                <label style="font-size:0.85rem;color:var(--text-muted);">
                    الثيم:
                    <select id="themeSelect">
                        <option value="theme-default">افتراضي</option>
                        <option value="theme-blue">أزرق هادئ</option>
                        <option value="theme-slate">رمادي أنيق</option>
                        <option value="theme-ocean">بحري مريح</option>
                        <option value="theme-olive">أخضر هادئ</option>
                    </select>
                </label>
            </div>
        </header>

        <!-- Dashboard -->
        <section id="dashboardSection" class="page-section active">
            <div class="card">
                <div class="stats-row" id="dashboardStatsRow">
                    <div class="stat-card">
                        <div class="stat-label">إجمالي الموظفين</div>
                        <div class="stat-value" id="totalEmployees">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">الذكور</div>
                        <div class="stat-value" id="totalMales">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">الإناث</div>
                        <div class="stat-value" id="totalFemales">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">الحالة الوظيفية</div>
                        <div class="stat-chip-row" id="statusChips"></div>
                    </div>
                </div>
                <p style="font-size:0.85rem;color:var(--text-muted);margin-top:0.4rem;">
                    يمكنك إدارة بيانات الموظفين من تبويب <strong>الموظفون</strong>، ثم مراجعة الإحصائيات التفصيلية من تبويب
                    <strong>التقارير</strong>.
                </p>
            </div>
        </section>

        <!-- Employees -->
        <section id="employeesSection" class="page-section">
            <div class="card" style="margin-bottom:0.75rem;">
                <div class="toolbar">
                    <button class="btn" id="addEmployeeBtn">+ إضافة موظف جديد</button>
                    <button class="btn-secondary" id="saveDataBtn">حفظ البيانات</button>
                    <div class="toolbar-right">
                        <button class="btn-secondary" id="importExcelBtn">استيراد من Excel</button>
                        <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none;">
                        <button class="btn-secondary" id="exportExcelBtn">تصدير إلى Excel</button>
                        <button class="btn-secondary" id="exportCsvBtn">تصدير CSV</button>
                        <button class="btn-secondary" id="importJsonBtn">استيراد JSON</button>
                        <input type="file" id="importJsonInput" accept=".json" style="display:none;">
                        <button class="btn-secondary" id="exportJsonBtn">تصدير JSON</button>
                    </div>
                </div>
                <div class="filters-row">
                    <input type="text" id="searchByName" placeholder="بحث بالاسم ...">
                    <select id="filterByStatus">
                        <option value="">كل الحالات الوظيفية</option>
                    </select>
                    <select id="filterByDepartment">
                        <option value="">كل الدوائر</option>
                    </select>
                    <select id="filterByGender">
                        <option value="">كل الأنواع</option>
                        <option value="ذكر">ذكر</option>
                        <option value="أنثى">أنثى</option>
                    </select>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="employeesTable">
                    <thead>
                    <tr>
                        <th style="min-width:40px;">#</th>
                        <th class="sortable" data-sort-key="firstName">الأسم الاول</th>
                        <th class="sortable" data-sort-key="secondName">الأسم الثاني</th>
                        <th class="sortable" data-sort-key="thirdName">الأسم الثالث</th>
                        <th class="sortable" data-sort-key="fourthName">الأسم الرابع</th>
                        <th class="sortable" data-sort-key="jobTitle">العنوان الوظيفي</th>
                        <th class="sortable" data-sort-key="jobStatus">الحالة الوظيفية</th>
                        <th class="sortable" data-sort-key="notes">الملاحظات</th>
                        <th class="sortable" data-sort-key="department">أسم الدائرة / مبنى الوزارة</th>
                        <th class="sortable" data-sort-key="jobNumber">الرقم الوظيفي</th>
                        <th class="sortable" data-sort-key="nationalId">الرقم الوطني</th>
                        <th class="sortable" data-sort-key="motherName">أسم الأم الثلاثي</th>
                        <th class="sortable" data-sort-key="gender">الجنس</th>
                        <th class="sortable" data-sort-key="birthDate">تاريخ التولد</th>
                        <th class="sortable" data-sort-key="hireDate">تاريخ التعيين</th>
                        <th style="min-width:120px;">إجراءات</th>
                    </tr>
                    </thead>
                    <tbody id="employeesTbody">
                    <!-- يتم الحشو عبر JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Leaves -->
        <section id="leavesSection" class="page-section">
            <div class="card">
                <h3 style="margin-top:0;">الإجازات</h3>
                <p style="font-size:0.85rem;color:var(--text-muted);">
                    يمكن لاحقاً إضافة نموذج لإدارة طلبات الإجازة والموافقة عليها وربطها بملف كل موظف.
                </p>
            </div>
        </section>

        <!-- Reports -->
        <section id="reportsSection" class="page-section">
            <div class="card">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-label">إجمالي الموظفين</div>
                        <div class="stat-value" id="reportTotalEmployees">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">إجمالي الذكور</div>
                        <div class="stat-value" id="reportMales">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">إجمالي الإناث</div>
                        <div class="stat-value" id="reportFemales">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">عدد الدوائر</div>
                        <div class="stat-value" id="reportDepartmentsCount">0</div>
                    </div>
                </div>

                <div class="stats-row" style="margin-top:0.6rem;">
                    <div class="stat-card">
                        <h4 style="font-size:0.9rem;margin:0 0 0.4rem;">توزيع الموظفين حسب الجنس</h4>
                        <table class="table table-sm mb-0" style="width:100%;font-size:0.78rem;">
                            <thead>
                            <tr>
                                <th>الجنس</th>
                                <th>العدد</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>ذكر</td>
                                <td id="genderMaleReport">0</td>
                            </tr>
                            <tr>
                                <td>أنثى</td>
                                <td id="genderFemaleReport">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="stat-card">
                        <h4 style="font-size:0.9rem;margin:0 0 0.4rem;">توزيع الموظفين حسب الحالة الوظيفية</h4>
                        <div id="statusReportList" style="font-size:0.78rem;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Logout -->
        <section id="logoutSection" class="page-section">
            <div class="card">
                <h3 style="margin-top:0;">تسجيل الخروج</h3>
                <p style="font-size:0.85rem;color:var(--text-muted);">
                    في بيئة حقيقية يمكن ربط هذا الزر بنظام الدخول الموحد. حالياً هو مجرد تبويب شكلي.
                </p>
            </div>
        </section>
    </main>
</div>

<!-- Modal: Employee -->
<div class="modal-backdrop" id="employeeModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header">
            <div class="modal-title" id="employeeModalTitle">إضافة موظف جديد</div>
            <button class="close-icon-btn" id="closeEmployeeModalBtn" title="إغلاق">
                ✕
            </button>
        </div>
        <div class="modal-body">
            <form id="employeeForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstNameInput">الأسم الاول</label>
                        <input type="text" id="firstNameInput" required>
                    </div>
                    <div class="form-group">
                        <label for="secondNameInput">الأسم الثاني</label>
                        <input type="text" id="secondNameInput">
                    </div>
                    <div class="form-group">
                        <label for="thirdNameInput">الأسم الثالث</label>
                        <input type="text" id="thirdNameInput">
                    </div>
                    <div class="form-group">
                        <label for="fourthNameInput">الأسم الرابع</label>
                        <input type="text" id="fourthNameInput">
                    </div>

                    <div class="form-group">
                        <label for="jobTitleInput">العنوان الوظيفي</label>
                        <input type="text" id="jobTitleInput">
                    </div>
                    <div class="form-group">
                        <label for="jobStatusInput">الحالة الوظيفية</label>
                        <select id="jobStatusInput">
                            <option value="">غير محدد</option>
                            <option value="مستمر بالخدمة">مستمر بالخدمة</option>
                            <option value="إجازة">إجازة</option>
                            <option value="متقاعد">متقاعد</option>
                            <option value="مجاز دراسياً">مجاز دراسياً</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="departmentInput">أسم الدائرة / مبنى الوزارة</label>
                        <input type="text" id="departmentInput">
                    </div>
                    <div class="form-group">
                        <label for="jobNumberInput">الرقم الوظيفي</label>
                        <input type="text" id="jobNumberInput">
                    </div>

                    <div class="form-group">
                        <label for="nationalIdInput">الرقم الوطني</label>
                        <input type="text" id="nationalIdInput">
                    </div>
                    <div class="form-group">
                        <label for="motherNameInput">أسم الأم الثلاثي</label>
                        <input type="text" id="motherNameInput">
                    </div>
                    <div class="form-group">
                        <label for="genderInput">الجنس</label>
                        <select id="genderInput">
                            <option value="">غير محدد</option>
                            <option value="ذكر">ذكر</option>
                            <option value="أنثى">أنثى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDateInput">تاريخ التولد</label>
                        <input type="date" id="birthDateInput">
                    </div>

                    <div class="form-group">
                        <label for="hireDateInput">تاريخ التعيين</label>
                        <input type="date" id="hireDateInput">
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label for="notesInput">الملاحظات</label>
                        <textarea id="notesInput" placeholder="ملاحظات إضافية إن وجدت"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelEmployeeModalBtn">إلغاء</button>
                    <button type="submit" class="btn" id="saveEmployeeBtn">حفظ البيانات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    (function () {
        "use strict";

        const STORAGE_KEY_EMPLOYEES = "hrEmployeesData_v1";
        const STORAGE_KEY_THEME = "hrTheme";
        const STORAGE_KEY_SECTION = "hrActiveSection";

        const excelHeaders = [
            "الأسم الاول",
            "الأسم الثاني",
            "الأسم الثالث",
            "الأسم الرابع",
            "العنوان الوظيفي",
            "الحالة الوظيفية",
            "الملاحظات",
            "أسم الدائرة / مبنى الوزارة",
            "الرقم الوظيفي",
            "الرقم الوطني",
            "أسم الأم الثلاثي",
            "الجنس",
            "تاريخ التولد",
            "تاريخ التعيين"
        ];

        const sidebarLinks = document.querySelectorAll(".sidebar-nav-link");
        const sections = document.querySelectorAll(".page-section");

        const themeSelect = document.getElementById("themeSelect");

        const employeesTbody = document.getElementById("employeesTbody");
        const searchByName = document.getElementById("searchByName");
        const filterByStatus = document.getElementById("filterByStatus");
        const filterByDepartment = document.getElementById("filterByDepartment");
        const filterByGender = document.getElementById("filterByGender");

        const addEmployeeBtn = document.getElementById("addEmployeeBtn");
        const saveDataBtn = document.getElementById("saveDataBtn");

        const importExcelBtn = document.getElementById("importExcelBtn");
        const importExcelInput = document.getElementById("importExcelInput");
        const exportExcelBtn = document.getElementById("exportExcelBtn");
        const exportCsvBtn = document.getElementById("exportCsvBtn");

        const importJsonBtn = document.getElementById("importJsonBtn");
        const importJsonInput = document.getElementById("importJsonInput");
        const exportJsonBtn = document.getElementById("exportJsonBtn");

        const employeeModalBackdrop = document.getElementById("employeeModalBackdrop");
        const closeEmployeeModalBtn = document.getElementById("closeEmployeeModalBtn");
        const cancelEmployeeModalBtn = document.getElementById("cancelEmployeeModalBtn");
        const employeeModalTitle = document.getElementById("employeeModalTitle");
        const employeeForm = document.getElementById("employeeForm");
        const saveEmployeeBtn = document.getElementById("saveEmployeeBtn");

        const firstNameInput = document.getElementById("firstNameInput");
        const secondNameInput = document.getElementById("secondNameInput");
        const thirdNameInput = document.getElementById("thirdNameInput");
        const fourthNameInput = document.getElementById("fourthNameInput");
        const jobTitleInput = document.getElementById("jobTitleInput");
        const jobStatusInput = document.getElementById("jobStatusInput");
        const departmentInput = document.getElementById("departmentInput");
        const jobNumberInput = document.getElementById("jobNumberInput");
        const nationalIdInput = document.getElementById("nationalIdInput");
        const motherNameInput = document.getElementById("motherNameInput");
        const genderInput = document.getElementById("genderInput");
        const birthDateInput = document.getElementById("birthDateInput");
        const hireDateInput = document.getElementById("hireDateInput");
        const notesInput = document.getElementById("notesInput");

        const totalEmployeesEl = document.getElementById("totalEmployees");
        const totalMalesEl = document.getElementById("totalMales");
        const totalFemalesEl = document.getElementById("totalFemales");
        const statusChipsEl = document.getElementById("statusChips");

        const reportTotalEmployees = document.getElementById("reportTotalEmployees");
        const reportMales = document.getElementById("reportMales");
        const reportFemales = document.getElementById("reportFemales");
        const reportDepartmentsCount = document.getElementById("reportDepartmentsCount");
        const genderMaleReport = document.getElementById("genderMaleReport");
        const genderFemaleReport = document.getElementById("genderFemaleReport");
        const statusReportList = document.getElementById("statusReportList");

        const toastEl = document.getElementById("toast");

        let employees = [];
        let editingIndex = null;
        let modalMode = "add"; // add | edit | view
        let sortState = {key: null, direction: "asc"};

        // Utility -----------------------------------

        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.add("show");
            setTimeout(() => toastEl.classList.remove("show"), 2200);
        }

        function persistEmployees() {
            try {
                localStorage.setItem(STORAGE_KEY_EMPLOYEES, JSON.stringify(employees));
            } catch (e) {
                console.error("Cannot save employees", e);
            }
        }

        function loadEmployeesFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_EMPLOYEES);
                if (raw) {
                    employees = JSON.parse(raw) || [];
                }
            } catch (e) {
                employees = [];
            }

            if (!Array.isArray(employees) || employees.length === 0) {
                // بيانات تجريبية بسيطة
                employees = [
                    {
                        firstName: "توفيق",
                        secondName: "سالم",
                        thirdName: "ابتهال",
                        fourthName: "",
                        jobTitle: "رئيس أطباء اختصاص",
                        jobStatus: "مستمر بالخدمة",
                        notes: "بورد عراقي",
                        department: "مكتب الوزير / الملاك",
                        jobNumber: "113023332",
                        nationalId: "196758925337",
                        motherName: "سعاد محمد مبارك",
                        gender: "أنثى",
                        birthDate: "1967-05-10",
                        hireDate: "1991-11-01"
                    },
                    {
                        firstName: "ابتهاج",
                        secondName: "فتاح",
                        thirdName: "عواد",
                        fourthName: "",
                        jobTitle: "تقني أشعة وسونار",
                        jobStatus: "مستمر بالخدمة",
                        notes: "إستثناء من التدرج",
                        department: "مكتب الوزير / الملاك",
                        jobNumber: "153435104",
                        nationalId: "200065880073",
                        motherName: "ابتهال محمد سلمان",
                        gender: "ذكر",
                        birthDate: "2000-02-15",
                        hireDate: "2023-11-19"
                    }
                ];
                persistEmployees();
            }
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute("data-theme", theme);
            try {
                localStorage.setItem(STORAGE_KEY_THEME, theme);
            } catch (e) {
            }
        }

        function getSavedTheme() {
            try {
                return localStorage.getItem(STORAGE_KEY_THEME) || "theme-default";
            } catch (e) {
                return "theme-default";
            }
        }

        function saveActiveSection(id) {
            try {
                localStorage.setItem(STORAGE_KEY_SECTION, id);
            } catch (e) {
            }
        }

        function getActiveSection() {
            try {
                return localStorage.getItem(STORAGE_KEY_SECTION) || "employeesSection";
            } catch (e) {
                return "employeesSection";
            }
        }

        // Navigation -------------------------------

        function setActiveSection(sectionId) {
            sections.forEach(s => {
                s.classList.toggle("active", s.id === sectionId);
            });
            sidebarLinks.forEach(l => {
                l.classList.toggle("active", l.dataset.section === sectionId);
            });
            saveActiveSection(sectionId);
        }

        sidebarLinks.forEach(link => {
            link.addEventListener("click", () => {
                const sectionId = link.dataset.section;
                setActiveSection(sectionId);
            });
        });

        // Employees rendering & filters ------------

        function matchesFilters(emp) {
            const nameQuery = (searchByName.value || "").trim();
            const status = filterByStatus.value;
            const department = filterByDepartment.value;
            const gender = filterByGender.value;

            let ok = true;

            if (nameQuery) {
                const fullName = [emp.firstName, emp.secondName, emp.thirdName, emp.fourthName].join(" ");
                ok = fullName.includes(nameQuery);
            }

            if (ok && status) {
                ok = emp.jobStatus === status;
            }

            if (ok && department) {
                ok = emp.department === department;
            }

            if (ok && gender) {
                ok = emp.gender === gender;
            }

            return ok;
        }

        function compareValues(a, b) {
            if (a == null) a = "";
            if (b == null) b = "";
            const isDate = /^\d{4}-\d{2}-\d{2}$/.test(a) && /^\d{4}-\d{2}-\d{2}$/.test(b);
            if (isDate) {
                return a.localeCompare(b);
            }
            const na = Number(a);
            const nb = Number(b);
            if (!isNaN(na) && !isNaN(nb)) {
                return na - nb;
            }
            return String(a).localeCompare(String(b), "ar");
        }

        function renderEmployees() {
            const rows = employees
                .map((emp, index) => ({emp, index}))
                .filter(row => matchesFilters(row.emp));

            if (sortState.key) {
                rows.sort((a, b) => {
                    const v1 = a.emp[sortState.key] || "";
                    const v2 = b.emp[sortState.key] || "";
                    const cmp = compareValues(v1, v2);
                    return sortState.direction === "asc" ? cmp : -cmp;
                });
            }

            employeesTbody.innerHTML = "";
            rows.forEach((row, displayIndex) => {
                const emp = row.emp;
                const tr = document.createElement("tr");

                const idxTd = document.createElement("td");
                idxTd.textContent = displayIndex + 1;
                tr.appendChild(idxTd);

                function td(text) {
                    const cell = document.createElement("td");
                    cell.textContent = text || "";
                    return cell;
                }

                tr.appendChild(td(emp.firstName));
                tr.appendChild(td(emp.secondName));
                tr.appendChild(td(emp.thirdName));
                tr.appendChild(td(emp.fourthName));
                tr.appendChild(td(emp.jobTitle));

                const statusTd = document.createElement("td");
                const statusBadge = document.createElement("span");
                statusBadge.className = "badge";
                let statusClass = "badge-muted";
                if (emp.jobStatus === "مستمر بالخدمة") statusClass = "badge-success";
                else if (emp.jobStatus && emp.jobStatus.indexOf("إجازة") !== -1) statusClass = "badge-warning";
                statusBadge.classList.add(statusClass);
                statusBadge.textContent = emp.jobStatus || "غير محدد";
                statusTd.appendChild(statusBadge);
                tr.appendChild(statusTd);

                tr.appendChild(td(emp.notes));
                tr.appendChild(td(emp.department));
                tr.appendChild(td(emp.jobNumber));
                tr.appendChild(td(emp.nationalId));
                tr.appendChild(td(emp.motherName));
                tr.appendChild(td(emp.gender));
                tr.appendChild(td(emp.birthDate));
                tr.appendChild(td(emp.hireDate));

                const actionsTd = document.createElement("td");
                actionsTd.className = "table-actions";

                const viewBtn = document.createElement("button");
                viewBtn.className = "btn btn-ghost";
                viewBtn.textContent = "عرض";
                viewBtn.addEventListener("click", () => openEmployeeModal(row.index, "view"));
                actionsTd.appendChild(viewBtn);

                const editBtn = document.createElement("button");
                editBtn.className = "btn btn-secondary";
                editBtn.textContent = "تعديل";
                editBtn.addEventListener("click", () => openEmployeeModal(row.index, "edit"));
                actionsTd.appendChild(editBtn);

                const delBtn = document.createElement("button");
                delBtn.className = "btn btn-danger";
                delBtn.textContent = "حذف";
                delBtn.addEventListener("click", () => deleteEmployee(row.index));
                actionsTd.appendChild(delBtn);

                tr.appendChild(actionsTd);

                employeesTbody.appendChild(tr);
            });

            renderFiltersOptions();
            renderEmployeeStats();
        }

        function renderFiltersOptions() {
            const statuses = new Set();
            const departments = new Set();
            employees.forEach(emp => {
                if (emp.jobStatus) statuses.add(emp.jobStatus);
                if (emp.department) departments.add(emp.department);
            });

            const currentStatus = filterByStatus.value;
            const currentDept = filterByDepartment.value;

            filterByStatus.innerHTML = '<option value="">كل الحالات الوظيفية</option>';
            statuses.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s;
                opt.textContent = s;
                filterByStatus.appendChild(opt);
            });
            filterByStatus.value = currentStatus || "";

            filterByDepartment.innerHTML = '<option value="">كل الدوائر</option>';
            departments.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d;
                opt.textContent = d;
                filterByDepartment.appendChild(opt);
            });
            filterByDepartment.value = currentDept || "";
        }

        function renderEmployeeStats() {
            const total = employees.length;
            let males = 0;
            let females = 0;
            const statusCount = {};
            const departments = new Set();

            employees.forEach(emp => {
                if (emp.gender === "ذكر") males++;
                else if (emp.gender === "أنثى") females++;
                if (emp.department) departments.add(emp.department);
                if (emp.jobStatus) {
                    statusCount[emp.jobStatus] = (statusCount[emp.jobStatus] || 0) + 1;
                }
            });

            totalEmployeesEl.textContent = total;
            totalMalesEl.textContent = males;
            totalFemalesEl.textContent = females;

            reportTotalEmployees.textContent = total;
            reportMales.textContent = males;
            reportFemales.textContent = females;
            reportDepartmentsCount.textContent = departments.size;
            genderMaleReport.textContent = males;
            genderFemaleReport.textContent = females;

            statusChipsEl.innerHTML = "";
            statusReportList.innerHTML = "";

            Object.keys(statusCount).forEach(status => {
                const chip = document.createElement("span");
                chip.className = "stat-chip";
                chip.textContent = status + " : " + statusCount[status];
                statusChipsEl.appendChild(chip);

                const line = document.createElement("div");
                line.textContent = status + " : " + statusCount[status];
                statusReportList.appendChild(line);
            });
        }

        // Modal ------------------------------------

        function resetEmployeeForm() {
            employeeForm.reset();
            [firstNameInput, secondNameInput, thirdNameInput, fourthNameInput,
                jobTitleInput, jobStatusInput, departmentInput, jobNumberInput,
                nationalIdInput, motherNameInput, genderInput,
                birthDateInput, hireDateInput, notesInput
            ].forEach(el => el.disabled = false);
            saveEmployeeBtn.style.display = "";
        }

        function openEmployeeModal(index, mode) {
            resetEmployeeForm();
            modalMode = mode || "add";

            if (mode === "add") {
                editingIndex = null;
                employeeModalTitle.textContent = "إضافة موظف جديد";
            } else if (mode === "edit" || mode === "view") {
                editingIndex = index;
                const emp = employees[index];
                if (!emp) return;

                firstNameInput.value = emp.firstName || "";
                secondNameInput.value = emp.secondName || "";
                thirdNameInput.value = emp.thirdName || "";
                fourthNameInput.value = emp.fourthName || "";
                jobTitleInput.value = emp.jobTitle || "";
                jobStatusInput.value = emp.jobStatus || "";
                departmentInput.value = emp.department || "";
                jobNumberInput.value = emp.jobNumber || "";
                nationalIdInput.value = emp.nationalId || "";
                motherNameInput.value = emp.motherName || "";
                genderInput.value = emp.gender || "";
                birthDateInput.value = emp.birthDate || "";
                hireDateInput.value = emp.hireDate || "";
                notesInput.value = emp.notes || "";

                employeeModalTitle.textContent = mode === "edit" ? "تعديل بيانات الموظف" : "عرض بيانات الموظف";

                if (mode === "view") {
                    [firstNameInput, secondNameInput, thirdNameInput, fourthNameInput,
                        jobTitleInput, jobStatusInput, departmentInput, jobNumberInput,
                        nationalIdInput, motherNameInput, genderInput,
                        birthDateInput, hireDateInput, notesInput
                    ].forEach(el => el.disabled = true);
                    saveEmployeeBtn.style.display = "none";
                }
            }

            employeeModalBackdrop.classList.add("open");
        }

        function closeEmployeeModal() {
            employeeModalBackdrop.classList.remove("open");
        }

        addEmployeeBtn.addEventListener("click", () => openEmployeeModal(null, "add"));
        closeEmployeeModalBtn.addEventListener("click", closeEmployeeModal);
        cancelEmployeeModalBtn.addEventListener("click", closeEmployeeModal);

        employeeModalBackdrop.addEventListener("click", (e) => {
            if (e.target === employeeModalBackdrop) {
                closeEmployeeModal();
            }
        });

        employeeForm.addEventListener("submit", (e) => {
            e.preventDefault();
            if (modalMode === "view") {
                closeEmployeeModal();
                return;
            }

            const newEmp = {
                firstName: firstNameInput.value.trim(),
                secondName: secondNameInput.value.trim(),
                thirdName: thirdNameInput.value.trim(),
                fourthName: fourthNameInput.value.trim(),
                jobTitle: jobTitleInput.value.trim(),
                jobStatus: jobStatusInput.value,
                notes: notesInput.value.trim(),
                department: departmentInput.value.trim(),
                jobNumber: jobNumberInput.value.trim(),
                nationalId: nationalIdInput.value.trim(),
                motherName: motherNameInput.value.trim(),
                gender: genderInput.value,
                birthDate: birthDateInput.value,
                hireDate: hireDateInput.value
            };

            if (!newEmp.firstName) {
                alert("يرجى إدخال الأسم الاول.");
                return;
            }

            if (editingIndex == null) {
                employees.push(newEmp);
            } else {
                employees[editingIndex] = newEmp;
            }

            persistEmployees();
            renderEmployees();
            showToast("تم حفظ بيانات الموظف.");
            closeEmployeeModal();
        });

        function deleteEmployee(index) {
            const emp = employees[index];
            if (!emp) return;
            if (confirm("هل أنت متأكد من حذف هذا الموظف؟")) {
                employees.splice(index, 1);
                persistEmployees();
                renderEmployees();
                showToast("تم حذف الموظف.");
            }
        }

        // Sorting ----------------------------------

        const headerCells = document.querySelectorAll("#employeesTable thead th.sortable");
        headerCells.forEach(th => {
            th.addEventListener("click", () => {
                const key = th.dataset.sortKey;
                if (!key) return;
                if (sortState.key === key) {
                    sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
                } else {
                    sortState.key = key;
                    sortState.direction = "asc";
                }

                headerCells.forEach(h => {
                    h.classList.remove("sorted-asc", "sorted-desc");
                });
                th.classList.add(sortState.direction === "asc" ? "sorted-asc" : "sorted-desc");

                renderEmployees();
            });
        });

        // Filters events ---------------------------

        [searchByName, filterByStatus, filterByDepartment, filterByGender].forEach(el => {
            el.addEventListener("input", renderEmployees);
            el.addEventListener("change", renderEmployees);
        });

        // Theme -----------------------------------

        themeSelect.addEventListener("change", () => {
            applyTheme(themeSelect.value);
        });

        // Save data button -------------------------

        saveDataBtn.addEventListener("click", () => {
            persistEmployees();
            showToast("تم حفظ البيانات في المتصفح.");
        });

        // Excel Export / Import --------------------

        exportExcelBtn.addEventListener("click", () => {
            const wsData = [excelHeaders.slice()];
            employees.forEach(emp => {
                wsData.push([
                    emp.firstName || "",
                    emp.secondName || "",
                    emp.thirdName || "",
                    emp.fourthName || "",
                    emp.jobTitle || "",
                    emp.jobStatus || "",
                    emp.notes || "",
                    emp.department || "",
                    emp.jobNumber || "",
                    emp.nationalId || "",
                    emp.motherName || "",
                    emp.gender || "",
                    emp.birthDate || "",
                    emp.hireDate || ""
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "الموظفون");

            XLSX.writeFile(wb, "employees.xlsx");
        });

        exportCsvBtn.addEventListener("click", () => {
            const rows = [];
            rows.push(excelHeaders.join(","));
            employees.forEach(emp => {
                const row = [
                    emp.firstName || "",
                    emp.secondName || "",
                    emp.thirdName || "",
                    emp.fourthName || "",
                    emp.jobTitle || "",
                    emp.jobStatus || "",
                    emp.notes || "",
                    emp.department || "",
                    emp.jobNumber || "",
                    emp.nationalId || "",
                    emp.motherName || "",
                    emp.gender || "",
                    emp.birthDate || "",
                    emp.hireDate || ""
                ].map(v => '"' + String(v).replace(/"/g, '""') + '"');
                rows.push(row.join(","));
            });

            const blob = new Blob([rows.join("\n")], {type: "text/csv;charset=utf-8;"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "employees.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        importExcelBtn.addEventListener("click", () => importExcelInput.click());
        importExcelInput.addEventListener("change", handleExcelImport);

        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (ev) {
                const data = ev.target.result;
                const workbook = XLSX.read(data, {type: "binary"});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false});

                if (!rows.length) {
                    alert("الملف فارغ.");
                    return;
                }

                const headerRow = rows[0].map(h => String(h || "").trim());
                const missing = excelHeaders.filter(h => !headerRow.includes(h));
                if (missing.length) {
                    alert("لا يمكن قراءة الملف. الأعمدة التالية مفقودة:\n" + missing.join(" ، "));
                    return;
                }

                const idx = {};
                excelHeaders.forEach(h => {
                    idx[h] = headerRow.indexOf(h);
                });

                const imported = [];
                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r || !r.length) continue;

                    const emp = {
                        firstName: r[idx["الأسم الاول"]] || "",
                        secondName: r[idx["الأسم الثاني"]] || "",
                        thirdName: r[idx["الأسم الثالث"]] || "",
                        fourthName: r[idx["الأسم الرابع"]] || "",
                        jobTitle: r[idx["العنوان الوظيفي"]] || "",
                        jobStatus: r[idx["الحالة الوظيفية"]] || "",
                        notes: r[idx["الملاحظات"]] || "",
                        department: r[idx["أسم الدائرة / مبنى الوزارة"]] || "",
                        jobNumber: r[idx["الرقم الوظيفي"]] || "",
                        nationalId: r[idx["الرقم الوطني"]] || "",
                        motherName: r[idx["أسم الأم الثلاثي"]] || "",
                        gender: r[idx["الجنس"]] || "",
                        birthDate: r[idx["تاريخ التولد"]] || "",
                        hireDate: r[idx["تاريخ التعيين"]] || ""
                    };

                    if (!emp.firstName && !emp.secondName && !emp.thirdName) continue;
                    imported.push(emp);
                }

                if (!imported.length) {
                    alert("لم يتم العثور على سجلات صالحة في الملف.");
                    return;
                }

                employees = imported;
                persistEmployees();
                renderEmployees();
                showToast("تم استيراد بيانات الموظفين من ملف Excel.");
                importExcelInput.value = "";
            };

            reader.readAsBinaryString(file);
        }

        // JSON Export / Import ---------------------

        exportJsonBtn.addEventListener("click", () => {
            const blob = new Blob([JSON.stringify(employees, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "employees.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        importJsonBtn.addEventListener("click", () => importJsonInput.click());
        importJsonInput.addEventListener("change", handleJsonImport);

        function handleJsonImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (!Array.isArray(data)) throw new Error("صيغة غير صحيحة.");

                    employees = data.map(emp => ({
                        firstName: emp.firstName || "",
                        secondName: emp.secondName || "",
                        thirdName: emp.thirdName || "",
                        fourthName: emp.fourthName || "",
                        jobTitle: emp.jobTitle || "",
                        jobStatus: emp.jobStatus || "",
                        notes: emp.notes || "",
                        department: emp.department || "",
                        jobNumber: emp.jobNumber || "",
                        nationalId: emp.nationalId || "",
                        motherName: emp.motherName || "",
                        gender: emp.gender || "",
                        birthDate: emp.birthDate || "",
                        hireDate: emp.hireDate || ""
                    }));

                    persistEmployees();
                    renderEmployees();
                    showToast("تم استيراد بيانات الموظفين من ملف JSON.");
                } catch (err) {
                    alert("تعذر قراءة ملف JSON. يرجى التأكد من الصيغة.");
                } finally {
                    importJsonInput.value = "";
                }
            };
            reader.readAsText(file, "utf-8");
        }

        // Init ------------------------------------

        document.addEventListener("DOMContentLoaded", () => {
            // تحميل الثيم المحفوظ وضبط القائمة
            const savedTheme = getSavedTheme();
            themeSelect.value = savedTheme;
            applyTheme(savedTheme);

            // إعادة فتح آخر تبويب بعد الإنعاش
            const activeSection = getActiveSection();
            setActiveSection(activeSection);

            // تحميل الموظفين
            loadEmployeesFromStorage();
            renderEmployees();
        });

    })();
</script>

</body>
</html>
